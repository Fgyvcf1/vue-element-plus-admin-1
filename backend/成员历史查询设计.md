# 成员任职历史查询设计方案

## 需求分析

### 场景说明
需要查询某个居民的历史任职记录,例如:
- 查询张三的完整任职历史
- 看张三在2020-2024年担任支部委员会书记
- 统计张三累计任职时长
- 查看某个职务的任职时间范围

### 核心功能
1. **成员历史列表** - 显示某人的所有任职记录
2. **时间轴视图** - 可视化展示任职历程
3. **统计信息** - 累计任职时间、届数统计
4. **详情查看** - 查看每届的完整信息

## 数据库设计

### committee_members 表 (现有)
已包含所有需要的历史数据:
```sql
CREATE TABLE committee_members (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  resident_id INTEGER NOT NULL,           -- 居民ID (用于关联查询)
  organization_type TEXT NOT NULL,           -- 机构类型
  term_number INTEGER NOT NULL,              -- 第几届
  term_start_date TEXT NOT NULL,              -- 任期开始
  term_end_date TEXT,                       -- 任期结束
  position TEXT NOT NULL,                    -- 职务
  status TEXT NOT NULL,                     -- 状态
  created_at TEXT
)
```

### 查询场景

#### 场景1: 查询某人的所有任职记录
```sql
SELECT 
  cm.id,
  cm.organization_type,
  cm.term_number,
  cm.position,
  cm.term_start_date,
  cm.term_end_date,
  cm.status,
  r.name as resident_name,
  r.gender,
  r.phone_number
FROM committee_members cm
JOIN residents r ON cm.resident_id = r.id
WHERE cm.resident_id = ?
ORDER BY cm.term_start_date DESC;
```

#### 场景2: 查询某人在某机构的任职历史
```sql
SELECT 
  cm.*,
  r.name as resident_name
FROM committee_members cm
JOIN residents r ON cm.resident_id = r.id
WHERE cm.resident_id = ? AND cm.organization_type = ?
ORDER BY cm.term_number DESC;
```

#### 场景3: 查询某人在某个职务的任职记录
```sql
SELECT 
  cm.*,
  r.name as resident_name
FROM committee_members cm
JOIN residents r ON cm.resident_id = r.id
WHERE cm.resident_id = ? 
  AND cm.position = ?
ORDER BY cm.term_start_date DESC;
```

#### 场景4: 统计累计任职时间
```sql
SELECT 
  r.name,
  r.id_card,
  COUNT(*) as total_terms,
  SUM(
    CASE 
      WHEN cm.term_end_date IS NULL 
        THEN julianday('now', cm.term_start_date)
      ELSE julianday(cm.term_end_date, cm.term_start_date)
    END
  ) as total_days
FROM committee_members cm
JOIN residents r ON cm.resident_id = r.id
WHERE cm.resident_id = ?
GROUP BY r.id, r.name, r.id_card;
```

## 前端实现方案

### 1. 成员历史页面

#### 页面结构
```vue
<template>
  <div class="member-history-container">
    <!-- 顶部搜索区 -->
    <el-card class="search-card">
      <el-form :inline="true" :model="searchForm">
        <el-form-item label="选择居民">
          <el-select
            v-model="searchForm.residentId"
            filterable
            remote
            :remote-method="searchResidents"
            @change="handleResidentChange"
          >
            <el-option
              v-for="item in residentOptions"
              :key="item.id"
              :label="item.name"
              :value="item.id"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="机构类型">
          <el-select v-model="searchForm.orgType" clearable>
            <el-option
              v-for="org in organizations"
              :key="org.value"
              :label="org.label"
              :value="org.value"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="职务">
          <el-input 
            v-model="searchForm.position" 
            placeholder="请输入职务" 
            clearable
          />
        </el-form-item>

        <el-form-item>
          <el-button type="primary" @click="handleSearch">查询</el-button>
          <el-button @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <!-- 统计信息卡片 -->
    <el-card v-if="statistics" class="statistics-card">
      <div slot="header">
        <span>任职统计</span>
      </div>
      <el-row :gutter="20">
        <el-col :span="6">
          <div class="stat-item">
            <div class="stat-value">{{ statistics.totalTerms }}</div>
            <div class="stat-label">总届数</div>
          </div>
        </el-col>
        <el-col :span="6">
          <div class="stat-item">
            <div class="stat-value">{{ statistics.currentTerms }}</div>
            <div class="stat-label">现任届数</div>
          </div>
        </el-col>
        <el-col :span="6">
          <div class="stat-item">
            <div class="stat-value">{{ statistics.totalDays }}</div>
            <div class="stat-label">累计天数</div>
          </div>
        </el-col>
        <el-col :span="6">
          <div class="stat-item">
            <div class="stat-value">{{ statistics.totalYears }}</div>
            <div class="stat-label">累计年数</div>
          </div>
        </el-col>
      </el-row>
    </el-card>

    <!-- 任职历史列表 -->
    <el-card class="history-list-card">
      <div slot="header">
        <span>任职历史</span>
      </div>

      <!-- 列表视图 -->
      <el-table :data="historyList" style="width: 100%">
        <el-table-column prop="term_number" label="届数" width="100">
          <template slot-scope="scope">
            第{{ scope.row.term_number }}届
          </template>
        </el-table-column>
        <el-table-column prop="organization_type" label="机构" width="150">
          <template slot-scope="scope">
            {{ getOrgTypeName(scope.row.organization_type) }}
          </template>
        </el-table-column>
        <el-table-column prop="position" label="职务" width="120" />
        <el-table-column prop="term_start_date" label="任职开始" width="120" />
        <el-table-column prop="term_end_date" label="任职结束" width="120">
          <template slot-scope="scope">
            {{ scope.row.term_end_date || '现任' }}
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态" width="100">
          <template slot-scope="scope">
            <el-tag :type="scope.row.status === 'current' ? 'success' : 'info'">
              {{ scope.row.status === 'current' ? '现任' : '历届' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="任职时长" width="120">
          <template slot-scope="scope">
            {{ calculateTermDays(scope.row) }}天
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- 时间轴视图 -->
    <el-card v-if="showTimeline" class="timeline-card">
      <div slot="header">
        <span>任职时间轴</span>
        <el-switch v-model="showTimeline" active-text="时间轴" inactive-text="列表" />
      </div>
      <el-timeline>
        <el-timeline-item
          v-for="(item, index) in sortedHistory"
          :key="item.id"
          :timestamp="item.term_start_date"
          :type="index === 0 ? 'primary' : 'success'"
        >
          <el-card>
            <h4>
              {{ getOrgTypeName(item.organization_type) }} 
              - 第{{ item.term_number }}届 - {{ item.position }}
            </h4>
            <p>任职时间: {{ item.term_start_date }} 至 {{ item.term_end_date || '至今' }}</p>
            <p v-if="item.remarks">备注: {{ item.remarks }}</p>
            <el-tag :type="item.status === 'current' ? 'success' : 'info'">
              {{ item.status === 'current' ? '现任' : '历届' }}
            </el-tag>
          </el-card>
        </el-timeline-item>
      </el-timeline>
    </el-card>
  </div>
</template>

<script>
export default {
  data() {
    return {
      searchForm: {
        residentId: null,
        orgType: null,
        position: ''
      },
      residentOptions: [],
      historyList: [],
      statistics: null,
      showTimeline: false,
      organizations: [
        { label: '支部委员会', value: 'branch_committee' },
        { label: '村民委员会', value: 'village_committee' },
        // ... 其他机构
      ]
    }
  },
  computed: {
    sortedHistory() {
      return [...this.historyList].sort((a, b) => 
        new Date(b.term_start_date) - new Date(a.term_start_date)
      );
    }
  },
  methods: {
    // 搜索居民
    async searchResidents(query) {
      const { data } = await getResidentsList({ name: query });
      this.residentOptions = data;
    },

    // 居民选择变化
    async handleResidentChange(residentId) {
      if (residentId) {
        await this.loadHistory(residentId);
        await this.loadStatistics(residentId);
      }
    },

    // 加载历史记录
    async loadHistory(residentId) {
      const params = { resident_id: residentId };
      if (this.searchForm.orgType) params.organization_type = this.searchForm.orgType;
      if (this.searchForm.position) params.position = this.searchForm.position;

      const { data } = await getMemberHistory(params);
      this.historyList = data;
    },

    // 加载统计信息
    async loadStatistics(residentId) {
      const { data } = await getMemberStatistics(residentId);
      if (data && data.length > 0) {
        this.statistics = data[0];
      }
    },

    // 计算任职天数
    calculateTermDays(row) {
      const start = new Date(row.term_start_date);
      const end = row.term_end_date ? new Date(row.term_end_date) : new Date();
      return Math.floor((end - start) / (1000 * 60 * 60 * 24));
    },

    // 获取机构类型名称
    getOrgTypeName(type) {
      const map = {
        'branch_committee': '支部委员会',
        'village_committee': '村民委员会',
        // ... 其他映射
      };
      return map[type] || type;
    }
  }
}
</script>

<style scoped>
.member-history-container {
  padding: 20px;
}

.search-card,
.statistics-card,
.history-list-card,
.timeline-card {
  margin-bottom: 20px;
}

.stat-item {
  text-align: center;
  padding: 20px 0;
}

.stat-value {
  font-size: 28px;
  font-weight: bold;
  color: #409EFF;
  margin-bottom: 10px;
}

.stat-label {
  font-size: 14px;
  color: #909399;
}
</style>
```

### 2. API接口

```javascript
// api/leadership.js

// 获取成员历史记录
export function getMemberHistory(params) {
  return request({
    url: '/committee-members/history',
    method: 'get',
    params
  })
}

// 获取成员统计信息
export function getMemberStatistics(residentId) {
  return request({
    url: '/committee-members/statistics',
    method: 'get',
    params: { resident_id: residentId }
  })
}
```

### 3. 后端API实现

```javascript
// routes.js

// 获取成员历史记录
router.get('/committee-members/history', (req, res) => {
  const { resident_id, organization_type, position } = req.query;

  let sql = `
    SELECT 
      cm.*,
      r.name as resident_name,
      r.gender,
      r.phone_number,
      r.id_card
    FROM committee_members cm
    JOIN residents r ON cm.resident_id = r.id
    WHERE cm.resident_id = ?
  `;
  const params = [resident_id];

  if (organization_type) {
    sql += ` AND cm.organization_type = ?`;
    params.push(organization_type);
  }

  if (position) {
    sql += ` AND cm.position = ?`;
    params.push(position);
  }

  sql += ` ORDER BY cm.term_start_date DESC, cm.term_number DESC`;

  db.all(sql, params, (err, rows) => {
    if (err) {
      console.error('查询成员历史失败:', err.message);
      res.json({ code: 500, message: '查询失败', data: [] });
      return;
    }

    res.json({ code: 20000, data: rows });
  });
});

// 获取成员统计信息
router.get('/committee-members/statistics', (req, res) => {
  const { resident_id } = req.query;

  // 计算总届数和现任届数
  const statsSql = `
    SELECT 
      r.name,
      r.id_card,
      COUNT(*) as total_terms,
      SUM(CASE WHEN cm.status = 'current' THEN 1 ELSE 0 END) as current_terms,
      SUM(
        CASE 
          WHEN cm.term_end_date IS NULL 
            THEN julianday('now') - julianday(cm.term_start_date)
          ELSE julianday(cm.term_end_date) - julianday(cm.term_start_date)
        END
      ) as total_days
    FROM committee_members cm
    JOIN residents r ON cm.resident_id = r.id
    WHERE cm.resident_id = ?
    GROUP BY r.id, r.name, r.id_card
  `;

  db.get(statsSql, [resident_id], (err, row) => {
    if (err) {
      console.error('查询统计信息失败:', err.message);
      res.json({ code: 500, message: '查询失败', data: null });
      return;
    }

    // 计算年数并转换字段名为驼峰命名法
    if (row) {
      const result = {
        name: row.name,
        idCard: row.id_card,
        totalTerms: row.total_terms,
        currentTerms: row.current_terms || 0,
        totalDays: row.total_days ? Math.round(row.total_days) : 0,
        totalYears: row.total_days ? (row.total_days / 365).toFixed(1) : '0.0'
      };
      row = result;
    }

    res.json({ code: 20000, data: row ? [row] : [] });
  });
});
```

## 使用场景

### 场景1: 查询张三的完整任职历史
1. 进入"成员历史查询"页面
2. 在下拉框中搜索并选择"张三"
3. 点击"查询"按钮
4. 显示张三的所有任职记录和统计信息

**显示结果:**
- 总届数: 5
- 现任届数: 1
- 累计天数: 1825天 (约5年)
- 任职时间轴: 从2020年至今的所有任职

### 场景2: 查询张三在支部委员会的任职
1. 选择居民: 张三
2. 选择机构类型: 支部委员会
3. 点击查询
4. 只显示张三在支部委员会的任职记录

### 场景3: 查询张三担任"书记"职务的历史
1. 选择居民: 张三
2. 输入职务: 书记
3. 点击查询
4. 显示张三所有担任书记的记录

## 数据示例

### 查询结果示例
```json
{
  "historyList": [
    {
      "id": 1,
      "residentId": 101,
      "residentName": "张三",
      "organizationType": "branch_committee",
      "organizationTypeName": "支部委员会",
      "termNumber": 10,
      "termStartDate": "2024-01-01",
      "termEndDate": null,
      "position": "书记",
      "status": "current"
    },
    {
      "id": 2,
      "residentId": 101,
      "residentName": "张三",
      "organizationType": "branch_committee",
      "organizationTypeName": "支部委员会",
      "termNumber": 9,
      "termStartDate": "2020-01-01",
      "termEndDate": "2023-12-31",
      "position": "副书记",
      "status": "history"
    }
  ],
  "statistics": {
    "name": "张三",
    "idCard": "510XXXXXXXXXXXXXX",
    "totalTerms": 5,
    "currentTerms": 1,
    "totalDays": 1825,
    "totalYears": "5.0"
  }
}
```

## 优势

### 1. 完整历史追溯
- 可以查看某人的完整任职历程
- 支持按机构、职务筛选
- 时间轴可视化展示

### 2. 统计分析
- 累计任职时间统计
- 届数统计
- 便于人员评估

### 3. 多维度查询
- 按人查询
- 按机构筛选
- 按职务筛选
- 组合查询

### 4. 用户体验
- 列表和时间轴两种视图
- 统计信息一目了然
- 搜索功能便捷

## 索引优化

```sql
-- 确保已有索引
CREATE INDEX IF NOT EXISTS idx_committee_members_resident_id 
ON committee_members(resident_id);

-- 居民ID索引已在全局索引脚本中创建
-- 查询性能有保障
```

## 扩展功能建议

1. **导出功能** - 导出成员历史为Excel
2. **打印功能** - 打印任职履历
3. **对比功能** - 对比不同居民的任职情况
4. **图表统计** - 用图表展示任职分布
