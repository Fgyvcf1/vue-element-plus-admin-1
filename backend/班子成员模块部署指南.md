# 班子成员管理模块 - 部署指南

## 一、功能概述

班子成员管理模块实现对8类机构成员信息的全生命周期管理：

### 8类机构
1. **支部委员会** - 按届集体管理
2. **村民委员会** - 按届集体管理
3. **集体经济组织理事会** - 按届集体管理
4. **集体经济组织监事会** - 按届集体管理
5. **村务监督委员会** - 按届集体管理
6. **村民小组长** - 显示全部名单，支持按届筛选
7. **村民代表** - 显示全部名单，支持按届筛选
8. **青年团妇组织** - 显示全部名单，支持按届筛选

### 核心功能
- ✅ 选项卡切换不同机构
- ✅ 届次管理与筛选
- ✅ 成员新增/编辑/删除
- ✅ 居民信息自动填充（下拉选择后自动填充姓名、性别、电话等）
- ✅ 职务字典动态加载（根据机构类型自动加载对应职务）
- ✅ 现任/历届状态筛选
- ✅ 成员历史任职查询（时间轴视图 + 统计）
- ✅ 数据库索引优化

---

## 二、部署步骤

### 步骤1：运行数据库初始化脚本

双击运行：
```
backend/初始化班子成员模块.bat
```

该脚本将依次执行：
1. 创建 `committee_members` 表
2. 插入职务字典数据
3. 创建全局数据库索引

### 步骤2：重启后端服务

如果后端服务正在运行，请重启以使新的API路由生效。

```bash
# 停止当前服务（Ctrl+C）
# 然后重新启动
cd backend
node server.js
```

### 步骤3：访问前端

启动前端服务（如果未启动）：
```bash
npm run dev
```

然后在浏览器中访问系统，左侧菜单会出现 **"班子成员管理"** 菜单项。

---

## 三、文件清单

### 前端文件
```
src/
├── api/
│   └── leadership.js                          # API接口定义
├── store/
│   └── modules/
│       └── leadership.js                      # Vuex状态管理
├── views/
│   └── leadership/
│       └── members/
│           ├── index.vue                       # 主页面（选项卡+列表）
│           └── components/
│               ├── MemberForm.vue              # 新增/编辑表单
│               └── HistoryTimeline.vue         # 历史任职时间轴
└── router/
    └── index.js                              # 路由配置（已添加）
```

### 后端文件
```
backend/
├── routes.js                                 # API路由（已添加班子成员API）
├── create-committee-tables.js                # 创建班子成员表
├── insert-position-dictionary.js              # 插入职务字典
├── create-global-indexes.js                  # 创建全局索引
└── app.db                                   # SQLite数据库（将新增committee_members表）
```

---

## 四、数据库表结构

### committee_members 表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| resident_id | INTEGER | 居民ID（关联residents表） |
| organization_type | TEXT | 机构类型（8种之一） |
| term_number | INTEGER | 届数 |
| term_start_date | TEXT | 任期开始日期 |
| term_end_date | TEXT | 任期结束日期（当前为空） |
| position | TEXT | 职务（从字典获取） |
| status | TEXT | 状态：current(现任) / history(历届) |
| remarks | TEXT | 备注 |
| created_at | TEXT | 创建时间 |
| updated_at | TEXT | 更新时间 |

### 字典表扩展

职务字典按机构分类，格式为 `职务_{机构名称}`：

- `职务_支部委员会` - 书记、副书记、委员
- `职务_村民委员会` - 主任、副主任、委员
- `职务_集体经济组织理事会` - 理事长、副理事长、理事
- `职务_集体经济组织监事会` - 主席、监事
- `职务_村务监督委员会` - 主任、副主任、委员
- `职务_村民小组长` - 组长
- `职务_村民代表` - 代表
- `职务_青年团妇组织` - 团支部书记、妇联主任、其他

---

## 五、API接口

### 1. 获取成员列表
```
GET /committee-members
```

参数：
- `organization_type` - 机构类型
- `term_number` - 届数（可选）
- `status` - 状态：current/history
- `page` - 页码
- `pageSize` - 每页条数
- `keyword` - 搜索关键词（姓名或职务）

### 2. 获取单个成员
```
GET /committee-members/:id
```

### 3. 添加成员
```
POST /committee-members
```

请求体：
```json
{
  "residentId": 101,
  "organizationType": "branch_committee",
  "termNumber": 10,
  "termStartDate": "2024-01-01",
  "termEndDate": null,
  "position": "书记",
  "status": "current",
  "remarks": "备注"
}
```

### 4. 更新成员
```
PUT /committee-members/:id
```

请求体：同添加成员

### 5. 删除成员
```
DELETE /committee-members/:id
```

### 6. 获取届数列表
```
GET /committee-members/term-numbers?organization_type=xxx
```

### 7. 获取成员历史任职记录
```
GET /committee-members/history?resident_id=xxx
```

---

## 六、使用说明

### 新增成员流程

1. 进入"班子成员管理" → "成员管理"
2. 选择机构类型（如"支部委员会"）
3. 点击"新增成员"按钮
4. 在弹窗中：
   - **选择居民**：输入姓名搜索，从居民下拉列表选择
   - **自动填充**：选择居民后自动填充姓名、性别、电话、身份证
   - **选择届数**：从下拉列表选择或新建一届
   - **选择职务**：根据当前机构类型自动加载对应职务选项
   - **设置任期**：选择开始日期，结束日期现任可不填
   - **设置状态**：现任或历届
5. 点击"确定"保存

### 查询历史任职

1. 在成员列表中，点击某行的"历史"按钮
2. 弹窗显示该居民的所有任职记录
3. 顶部显示统计信息：总届数、现任届数、累计天数、累计年数
4. 时间轴按时间顺序展示每届任职记录
5. 每条记录包含：机构、届数、职务、任期、备注

### 届次筛选

**前5个机构（集体换届机构）：**
- 默认显示当前届成员
- 可通过下拉框选择其他届
- 支持现任/历届筛选

**后3个机构（全部名单机构）：**
- 默认显示全部成员
- 通过点击届次标签筛选该届成员
- 点击"全部"标签显示所有成员

---

## 七、注意事项

### 数据库索引
系统已创建以下索引以优化性能：
- `residents` 表：`name`, `id_card`
- `committee_members` 表：`resident_id`, `organization_type`, `term_number`, `(organization_type, term_number)`

### 首次使用
1. 必须先运行初始化脚本创建表和索引
2. 建议先在字典管理中检查职务数据是否完整
3. 居民数据必须存在才能添加成员

### 数据校验
- 历届成员必须填写任期结束日期
- 任期结束日期不能早于开始日期
- 居民信息必选

---

## 八、常见问题

### Q: 运行初始化脚本报错？
A: 请检查后端 `sqlite3` 模块是否已安装。如果没有，运行：
```bash
cd backend
npm install sqlite3
```

### Q: 前端页面打不开？
A: 检查：
1. 后端服务是否已启动
2. API接口是否正常（访问 http://localhost:端口/committee-members）
3. 前端 `src/utils/request.js` 中的 baseURL 配置是否正确

### Q: 职务下拉框为空？
A: 检查字典表中是否有对应的职务数据。可通过以下方式添加：
- 系统管理 → 字典管理 → 添加职务
- 或运行 `insert-position-dictionary.js` 脚本

### Q: 居民搜索无结果？
A: 检查居民数据是否存在，以及居民状态是否为 `active`。

---

## 九、技术支持

如遇问题，请检查：
1. 浏览器控制台错误日志（F12）
2. 后端终端输出日志
3. 数据库表结构是否正确

---

## 十、版本信息

- 创建日期：2026-01-10
- 版本：v1.0.0
- 前端框架：Vue 2.6.10 + Element UI 2.13.2
- 后端框架：Node.js + Express + SQLite
