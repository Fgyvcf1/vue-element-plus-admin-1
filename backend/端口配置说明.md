# 后端服务配置说明

## 端口配置

**后端服务端口已固定为 3001**

### 端口自动清理

后端服务启动时会自动执行以下操作：

1. **检查端口占用**：检测端口3001是否被占用
2. **自动清理**：如果端口被占用，自动终止占用端口的进程
3. **启动服务**：确保端口释放后启动服务

### 端口清理流程

```javascript
// 启动前先杀死占用端口的进程
console.log(`检查端口 ${port} 是否被占用...`);
killPort(port);

// killPort 函数会：
// 1. 查找占用3001端口的进程
// 2. 终止这些进程
// 3. 验证端口已释放
```

## 启动后端服务

### 方式1：使用启动脚本

**Windows:**
```bash
start-all.bat
```

**Linux/Mac:**
```bash
./start-all.sh
```

### 方式2：直接启动

```bash
cd backend
node start-backend.js
```

### 启动日志示例

```
启动后端服务...

检查端口 3001 是否被占用...
端口 3001 未被占用

后端服务运行在 http://localhost:3001
CORS配置: 允许来自 localhost:4000 和 localhost:5173 的请求
居民查询API: http://localhost:3001/api/residents
```

### 如果端口被占用

```
启动后端服务...

检查端口 3001 是否被占用...
发现 1 个进程占用端口 3001: 15540
已终止占用端口 3001 的进程 15540
✓ 端口 3001 已释放

后端服务运行在 http://localhost:3001
...
```

## 服务信息

- **后端地址**: http://localhost:3001
- **居民查询API**: http://localhost:3001/api/residents
- **CORS允许的源**:
  - http://localhost:4000
  - http://127.0.0.1:4000
  - http://localhost:5173
  - http://127.0.0.1:5173

## 端口清理测试

如果需要测试端口清理功能，可以运行：

```bash
cd backend
node test-port-cleanup.js
```

## 注意事项

1. **端口固定**: 端口固定为3001，请勿随意修改
2. **自动清理**: 服务会自动清理占用端口的进程
3. **进程终止**: 占用端口的进程会被强制终止（taskkill /F）
4. **无需手动干预**: 正常情况下不需要手动处理端口占用问题

## 故障排查

### 问题1：端口清理失败

如果看到"端口3001仍被占用"的警告：

```bash
# 手动检查端口占用
netstat -ano | findstr :3001

# 手动终止进程
taskkill /F /PID <进程ID>
```

### 问题2：服务启动失败

如果服务启动失败，检查：

1. MariaDB服务是否运行
2. 端口是否真的被清理
3. 查看错误日志

```bash
# 检查MariaDB
net start mysql

# 检查端口
netstat -ano | findstr :3001
```

## 更新日志

- **2026-02-08**: 端口固定为3001，添加自动端口清理功能
