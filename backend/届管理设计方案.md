# "届"管理设计方案

## 业务背景

村级组织按"届"进行管理,例如:
- 第十届支部委员会
- 第十届村民委员会
- 第九届集体经济组织理事会

每一届有明确的任期时间,成员属于某一届。

## 核心概念

### 届 (Term)
- **届数**: 第几届 (如: 10)
- **机构类型**: 哪个机构的届 (如: 支部委员会)
- **任期时间**: 该届的开始和结束时间
- **成员归属**: 哪些成员属于这一届

### 成员与届的关系
- 一个居民可以在不同届担任不同职务
- 同一届的成员都在同一任期内
- 可以同时存在多届的历史数据

## 数据库设计

### 表结构

```sql
CREATE TABLE committee_members (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  resident_id INTEGER NOT NULL,           -- 居民ID
  organization_type TEXT NOT NULL,           -- 机构类型
  term_number INTEGER NOT NULL,              -- 第几届
  term_start_date TEXT NOT NULL,              -- 任期开始
  term_end_date TEXT,                       -- 任期结束 (当前届为空)
  position TEXT NOT NULL,                    -- 职务
  status TEXT NOT NULL DEFAULT 'current',      -- 状态: current(现任) | history(历届)
  remarks TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (resident_id) REFERENCES residents(id)
)
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| id | INTEGER | 是 | 主键 | 1 |
| resident_id | INTEGER | 是 | 关联居民ID | 101 |
| organization_type | TEXT | 是 | 机构类型 | 'branch_committee' |
| term_number | INTEGER | 是 | 第几届 | 10 |
| term_start_date | TEXT | 是 | 任期开始日期 | '2024-01-01' |
| term_end_date | TEXT | 否 | 任期结束日期 | null (当前届) |
| position | TEXT | 是 | 职务 | '书记' |
| status | TEXT | 否 | 状态 | 'current' |
| remarks | TEXT | 否 | 备注 | '' |

## 数据示例

### 场景: 第十届支部委员会

```json
[
  {
    "id": 1,
    "residentId": 101,
    "name": "张三",
    "organizationType": "branch_committee",
    "organizationTypeName": "支部委员会",
    "termNumber": 10,
    "termStartDate": "2024-01-01",
    "termEndDate": null,
    "position": "书记",
    "status": "current",
    "phone": "13800138000",
    "gender": "男"
  },
  {
    "id": 2,
    "residentId": 102,
    "name": "李四",
    "organizationType": "branch_committee",
    "organizationTypeName": "支部委员会",
    "termNumber": 10,
    "termStartDate": "2024-01-01",
    "termEndDate": null,
    "position": "副书记",
    "status": "current",
    "phone": "13900139000",
    "gender": "女"
  }
]
```

### 场景: 第九届支部委员会 (历届)

```json
[
  {
    "id": 3,
    "residentId": 201,
    "name": "王五",
    "organizationType": "branch_committee",
    "organizationTypeName": "支部委员会",
    "termNumber": 9,
    "termStartDate": "2020-01-01",
    "termEndDate": "2023-12-31",
    "position": "书记",
    "status": "history",
    "phone": "13700137000",
    "gender": "男"
  }
]
```

## 索引设计

```sql
-- 居民ID索引 (用于下拉查询)
CREATE INDEX idx_committee_members_resident_id ON committee_members(resident_id);

-- 机构类型索引 (用于Tab切换)
CREATE INDEX idx_committee_members_org_type ON committee_members(organization_type);

-- 状态索引 (用于现任/历届筛选)
CREATE INDEX idx_committee_members_status ON committee_members(status);

-- 届数索引 (用于按届查询)
CREATE INDEX idx_committee_members_term_number ON committee_members(term_number);

-- 复合索引 (机构+届数)
CREATE INDEX idx_committee_members_org_term ON committee_members(organization_type, term_number);
```

## 前端实现

### 1. 筛选条件

```vue
<template>
  <div class="filter-section">
    <!-- 机构类型 -->
    <el-tabs v-model="filters.organizationType" @tab-click="handleOrgChange">
      <el-tab-pane
        v-for="org in organizations"
        :key="org.value"
        :label="org.label"
        :name="org.value"
      />
    </el-tabs>

    <!-- 任届筛选 -->
    <div class="term-filter">
      <el-select
        v-model="filters.termNumber"
        placeholder="选择届数"
        clearable
        @change="handleSearch"
      >
        <el-option
          v-for="term in termOptions"
          :key="term.value"
          :label="`第${term.label}届`"
          :value="term.value"
        />
      </el-select>
    </div>

    <!-- 现任/历届 -->
    <el-radio-group v-model="filters.status" @change="handleSearch">
      <el-radio label="current">现任</el-radio>
      <el-radio label="history">历届</el-radio>
    </el-radio-group>
  </div>
</template>

<script>
export default {
  data() {
    return {
      filters: {
        organizationType: 'branch_committee',
        termNumber: null,
        status: 'current'
      },
      termOptions: [], // 届数选项
      organizations: [
        { label: '支部委员会', value: 'branch_committee' },
        { label: '村民委员会', value: 'village_committee' },
        // ... 其他机构
      ]
    }
  },
  methods: {
    // 机构切换时,重新加载届数选项
    async handleOrgChange() {
      await this.loadTermOptions(this.filters.organizationType);
      this.handleSearch();
    },

    // 加载届数选项
    async loadTermOptions(orgType) {
      const { data } = await getTermNumbers(orgType);
      this.termOptions = data.map(t => ({
        value: t.term_number,
        label: t.term_number
      }));
    },

    // 搜索成员列表
    async handleSearch() {
      await this.loadMembers();
    }
  }
}
</script>
```

### 2. 新增成员表单

```vue
<template>
  <el-form ref="form" :model="form" :rules="rules" label-width="120px">
    <!-- 居民选择 -->
    <el-form-item label="选择居民" prop="residentId">
      <el-select
        v-model="form.residentId"
        filterable
        remote
        :remote-method="searchResidents"
        @change="handleResidentChange"
      >
        <el-option
          v-for="item in residentOptions"
          :key="item.id"
          :label="item.name"
          :value="item.id"
        />
      </el-select>
    </el-form-item>

    <!-- 机构类型 -->
    <el-form-item label="机构类型" prop="organizationType">
      <el-select v-model="form.organizationType" @change="handleOrgChange">
        <el-option
          v-for="org in organizations"
          :key="org.value"
          :label="org.label"
          :value="org.value"
        />
      </el-select>
    </el-form-item>

    <!-- 届数 -->
    <el-form-item label="届数" prop="termNumber">
      <el-select
        v-model="form.termNumber"
        placeholder="请选择届数"
        :disabled="!form.organizationType"
      >
        <el-option
          v-for="term in availableTerms"
          :key="term.value"
          :label="`第${term.label}届`"
          :value="term.value"
        />
      </el-select>
    </el-form-item>

    <!-- 任期开始 -->
    <el-form-item label="任期开始" prop="termStartDate">
      <el-date-picker
        v-model="form.termStartDate"
        type="date"
        placeholder="选择日期"
      />
    </el-form-item>

    <!-- 任期结束 (历届必填) -->
    <el-form-item
      label="任期结束"
      prop="termEndDate"
      :rules="form.status === 'history' ? [{ required: true, message: '请选择任期结束' }] : []"
    >
      <el-date-picker
        v-model="form.termEndDate"
        type="date"
        placeholder="选择日期"
      />
    </el-form-item>

    <!-- 职务 -->
    <el-form-item label="职务" prop="position">
      <el-select
        v-model="form.position"
        placeholder="请选择职务"
        :disabled="!form.organizationType"
      >
        <el-option
          v-for="item in positionOptions"
          :key="item.id"
          :label="item.value"
          :value="item.value"
        />
      </el-select>
    </el-form-item>

    <!-- 状态 -->
    <el-form-item label="状态" prop="status">
      <el-radio-group v-model="form.status">
        <el-radio label="current">现任</el-radio>
        <el-radio label="history">历届</el-radio>
      </el-radio-group>
    </el-form-item>
  </el-form>
</template>

<script>
export default {
  data() {
    return {
      form: {
        residentId: null,
        organizationType: null,
        termNumber: null,
        termStartDate: new Date(),
        termEndDate: null,
        position: '',
        status: 'current'
      },
      availableTerms: [], // 可选届数
      positionOptions: [], // 职务选项
      rules: {
        residentId: [{ required: true, message: '请选择居民' }],
        organizationType: [{ required: true, message: '请选择机构类型' }],
        termNumber: [{ required: true, message: '请选择届数' }],
        termStartDate: [{ required: true, message: '请选择任期开始' }],
        position: [{ required: true, message: '请选择职务' }]
      }
    }
  },
  watch: {
    // 机构类型变化,加载届数和职务
    'form.organizationType'(newVal) {
      if (newVal) {
        this.loadAvailableTerms(newVal);
        this.loadPositionOptions(newVal);
      }
    }
  },
  methods: {
    // 加载可选届数
    async loadAvailableTerms(orgType) {
      const { data } = await getTermNumbers(orgType);
      this.availableTerms = data.map(t => ({
        value: t.term_number,
        label: t.term_number
      }));
    }
  }
}
</script>
```

## 后端API

### 1. 获取届数列表

```javascript
router.get('/committee-members/term-numbers', (req, res) => {
  const { organization_type } = req.query;

  const sql = `SELECT DISTINCT term_number
             FROM committee_members
             WHERE organization_type = ?
             ORDER BY term_number DESC`;

  db.all(sql, [organization_type], (err, rows) => {
    if (err) {
      console.error('查询届数失败:', err.message);
      res.json({ code: 500, message: '查询失败', data: [] });
      return;
    }

    res.json({ code: 20000, data: rows });
  });
});
```

### 2. 获取成员列表

```javascript
router.get('/committee-members/list', (req, res) => {
  const { organization_type, term_number, status, page, pageSize } = req.query;

  let sql = `SELECT cm.*, r.name, r.gender, r.phone_number, r.id_card
             FROM committee_members cm
             JOIN residents r ON cm.resident_id = r.id
             WHERE 1=1`;
  const params = [];

  if (organization_type) {
    sql += ` AND cm.organization_type = ?`;
    params.push(organization_type);
  }

  if (term_number) {
    sql += ` AND cm.term_number = ?`;
    params.push(term_number);
  }

  if (status) {
    sql += ` AND cm.status = ?`;
    params.push(status);
  }

  sql += ` ORDER BY cm.term_number DESC, cm.id LIMIT ? OFFSET ?`;

  db.all(sql, [...params, parseInt(pageSize), (parseInt(page) - 1) * parseInt(pageSize)], (err, rows) => {
    // ... 返回数据
  });
});
```

## 使用场景

### 场景1: 查看第十届支部委员会现任成员

1. 选择机构: 支部委员会
2. 选择届数: 第10届
3. 选择状态: 现任
4. 显示: 张三(书记)、李四(副书记)等

### 场景2: 新增第十一届成员

1. 点击"新增"
2. 选择机构: 支部委员会
3. 选择届数: 第11届(新建)
4. 设置任期: 2024-01-01 开始,结束为空
5. 选择居民: 张三
6. 选择职务: 书记
7. 状态: 现任
8. 提交保存

### 场景3: 第十届结束,切换第十一届

1. 查询第10届所有成员
2. 批量更新: status = 'history', term_end_date = '2023-12-31'
3. 新增第11届成员

## 优势

### 1. 业务清晰
- 届的概念明确,符合实际业务
- 时间管理统一,便于追溯

### 2. 查询方便
- 可以按届查询所有成员
- 可以查询某人在不同届的任职情况

### 3. 灵活扩展
- 支持任意多届历史数据
- 可以新增未来届(预备届)

### 4. 数据完整
- 保留完整的历史记录
- 便于统计和分析
