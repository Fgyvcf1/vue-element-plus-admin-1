const express = require('express')
const router = express.Router()
const db = require('../db')
const { checkPermission } = require('../middleware/auth');  // 引入权限检查中间件

// 获取当前本地时间（北京时间）的辅助函数
function getLocalTime() {
  const now = new Date()
  // 使用toISOString()获取UTC时间，然后手动调整时区
  const timezoneOffset = now.getTimezoneOffset() * 60000 // 转换为毫秒
  const localDate = new Date(now.getTime() - timezoneOffset)
  return localDate.toISOString().slice(0, 19).replace('T', ' ')
}

// 生成户主ID的辅助函数
function generateHouseholdId(villageGroup, idCard) {
  return new Promise((resolve, reject) => {
    // 1. 生成基础户主ID：村组名字首个字母大写 + 身份证后6位
    // 提取村组名称的前两个字的首字母大写
    let groupCode = ''
    if (villageGroup && villageGroup.length > 0) {
      // 简单的中文首字母提取函数
      const getChineseFirstLetter = (char) => {
        const unicode = char.charCodeAt(0)
        // 常用汉字拼音首字母映射表（完整版）
        const pinyinMap = {
          // A
          阿: 'A',
          艾: 'A',
          安: 'A',
          奥: 'A',
          // B
          巴: 'B',
          白: 'B',
          百: 'B',
          柏: 'B',
          班: 'B',
          半: 'B',
          邑: 'B',
          宝: 'B',
          保: 'B',
          堡: 'B',
          北: 'B',
          贝: 'B',
          本: 'B',
          比: 'B',
          必: 'B',
          边: 'B',
          变: 'B',
          标: 'B',
          表: 'B',
          别: 'B',
          宾: 'B',
          兵: 'B',
          冰: 'B',
          丙: 'B',
          病: 'B',
          波: 'B',
          博: 'B',
          伯: 'B',
          泊: 'B',
          卜: 'B',
          不: 'B',
          布: 'B',
          步: 'B',
          部: 'B',
          // C
          才: 'C',
          材: 'C',
          财: 'C',
          采: 'C',
          彩: 'C',
          菜: 'C',
          蔡: 'C',
          参: 'C',
          残: 'C',
          蚕: 'C',
          仓: 'C',
          苍: 'C',
          藏: 'C',
          操: 'C',
          曹: 'C',
          草: 'C',
          册: 'C',
          侧: 'C',
          测: 'C',
          策: 'C',
          层: 'C',
          曾: 'C',
          茶: 'C',
          查: 'C',
          察: 'C',
          差: 'C',
          拆: 'C',
          柴: 'C',
          缠: 'C',
          产: 'C',
          昌: 'C',
          长: 'C',
          场: 'C',
          厂: 'C',
          抄: 'C',
          超: 'C',
          朝: 'C',
          潮: 'C',
          车: 'C',
          扯: 'C',
          陈: 'C',
          晨: 'C',
          沉: 'C',
          称: 'C',
          城: 'C',
          成: 'C',
          承: 'C',
          诚: 'C',
          吃: 'C',
          池: 'C',
          驰: 'C',
          迟: 'C',
          持: 'C',
          尺: 'C',
          齿: 'C',
          赤: 'C',
          充: 'C',
          冲: 'C',
          虫: 'C',
          崇: 'C',
          抽: 'C',
          仇: 'C',
          绸: 'C',
          愁: 'C',
          筹: 'C',
          丑: 'C',
          初: 'C',
          出: 'C',
          础: 'C',
          储: 'C',
          楚: 'C',
          处: 'C',
          川: 'C',
          穿: 'C',
          传: 'C',
          船: 'C',
          窗: 'C',
          床: 'C',
          创: 'C',
          春: 'C',
          纯: 'C',
          唇: 'C',
          词: 'C',
          慈: 'C',
          辞: 'C',
          磁: 'C',
          雌: 'C',
          次: 'C',
          刺: 'C',
          从: 'C',
          匆: 'C',
          葱: 'C',
          聪: 'C',
          丛: 'C',
          凑: 'C',
          粗: 'C',
          促: 'C',
          村: 'C',
          存: 'C',
          寸: 'C',
          错: 'C',
          // D
          达: 'D',
          答: 'D',
          打: 'D',
          大: 'D',
          代: 'D',
          带: 'D',
          待: 'D',
          袋: 'D',
          戴: 'D',
          丹: 'D',
          单: 'D',
          担: 'D',
          胆: 'D',
          旦: 'D',
          但: 'D',
          诞: 'D',
          弹: 'D',
          淡: 'D',
          蛋: 'D',
          当: 'D',
          挡: 'D',
          党: 'D',
          荡: 'D',
          刀: 'D',
          导: 'D',
          岛: 'D',
          倒: 'D',
          蹈: 'D',
          到: 'D',
          盗: 'D',
          道: 'D',
          德: 'D',
          得: 'D',
          灯: 'D',
          登: 'D',
          等: 'D',
          邓: 'D',
          堤: 'D',
          低: 'D',
          滴: 'D',
          迪: 'D',
          敌: 'D',
          笛: 'D',
          底: 'D',
          地: 'D',
          弟: 'D',
          帝: 'D',
          递: 'D',
          第: 'D',
          颠: 'D',
          典: 'D',
          点: 'D',
          电: 'D',
          店: 'D',
          殿: 'D',
          雕: 'D',
          吊: 'D',
          调: 'D',
          跌: 'D',
          爹: 'D',
          叠: 'D',
          丁: 'D',
          叮: 'D',
          钉: 'D',
          顶: 'D',
          订: 'D',
          定: 'D',
          东: 'D',
          冬: 'D',
          董: 'D',
          懂: 'D',
          动: 'D',
          冻: 'D',
          栋: 'D',
          洞: 'D',
          都: 'D',
          斗: 'D',
          豆: 'D',
          督: 'D',
          毒: 'D',
          读: 'D',
          独: 'D',
          堵: 'D',
          赌: 'D',
          杜: 'D',
          肚: 'D',
          度: 'D',
          渡: 'D',
          端: 'D',
          短: 'D',
          段: 'D',
          断: 'D',
          堆: 'D',
          队: 'D',
          对: 'D',
          吨: 'D',
          敦: 'D',
          蹲: 'D',
          盾: 'D',
          多: 'D',
          夺: 'D',
          朵: 'D',
          躲: 'D',
          // E
          俄: 'E',
          额: 'E',
          恶: 'E',
          恩: 'E',
          儿: 'E',
          而: 'E',
          耳: 'E',
          二: 'E',
          // F
          发: 'F',
          乏: 'F',
          伐: 'F',
          罚: 'F',
          法: 'F',
          帆: 'F',
          番: 'F',
          翻: 'F',
          凡: 'F',
          烦: 'F',
          繁: 'F',
          反: 'F',
          返: 'F',
          犯: 'F',
          泛: 'F',
          饭: 'F',
          范: 'F',
          贩: 'F',
          方: 'F',
          芳: 'F',
          房: 'F',
          防: 'F',
          妨: 'F',
          仿: 'F',
          访: 'F',
          纺: 'F',
          放: 'F',
          飞: 'F',
          非: 'F',
          菲: 'F',
          肥: 'F',
          匪: 'F',
          废: 'F',
          沸: 'F',
          费: 'F',
          芬: 'F',
          纷: 'F',
          坟: 'F',
          粉: 'F',
          份: 'F',
          奋: 'F',
          愤: 'F',
          丰: 'F',
          风: 'F',
          枫: 'F',
          封: 'F',
          疯: 'F',
          峰: 'F',
          锋: 'F',
          蜂: 'F',
          冯: 'F',
          逢: 'F',
          缝: 'F',
          凤: 'F',
          奉: 'F',
          佛: 'F',
          夫: 'F',
          肤: 'F',
          孵: 'F',
          扶: 'F',
          拂: 'F',
          服: 'F',
          浮: 'F',
          符: 'F',
          幅: 'F',
          福: 'F',
          抚: 'F',
          府: 'F',
          斧: 'F',
          俯: 'F',
          辅: 'F',
          腐: 'F',
          父: 'F',
          付: 'F',
          妇: 'F',
          负: 'F',
          附: 'F',
          复: 'F',
          赴: 'F',
          副: 'F',
          傅: 'F',
          富: 'F',
          赋: 'F',
          腹: 'F',
          覆: 'F',
          // G
          该: 'G',
          改: 'G',
          盖: 'G',
          干: 'G',
          甘: 'G',
          杆: 'G',
          肝: 'G',
          赶: 'G',
          敢: 'G',
          感: 'G',
          刚: 'G',
          岗: 'G',
          纲: 'G',
          缸: 'G',
          钢: 'G',
          港: 'G',
          高: 'G',
          搞: 'G',
          稿: 'G',
          告: 'G',
          戈: 'G',
          哥: 'G',
          歌: 'G',
          阁: 'G',
          革: 'G',
          格: 'G',
          葛: 'G',
          隔: 'G',
          个: 'G',
          各: 'G',
          给: 'G',
          根: 'G',
          跟: 'G',
          更: 'G',
          耕: 'G',
          工: 'G',
          弓: 'G',
          公: 'G',
          功: 'G',
          攻: 'G',
          供: 'G',
          宫: 'G',
          恭: 'G',
          龚: 'G',
          共: 'G',
          贡: 'G',
          勾: 'G',
          沟: 'G',
          钩: 'G',
          狗: 'G',
          构: 'G',
          购: 'G',
          够: 'G',
          姑: 'G',
          孤: 'G',
          古: 'G',
          谷: 'G',
          股: 'G',
          骨: 'G',
          鼓: 'G',
          固: 'G',
          故: 'G',
          顾: 'G',
          瓜: 'G',
          刮: 'G',
          挂: 'G',
          乖: 'G',
          拐: 'G',
          怪: 'G',
          关: 'G',
          观: 'G',
          官: 'G',
          馆: 'G',
          管: 'G',
          贯: 'G',
          惯: 'G',
          灌: 'G',
          光: 'G',
          广: 'G',
          归: 'G',
          龟: 'G',
          规: 'G',
          轨: 'G',
          鬼: 'G',
          桂: 'G',
          柜: 'G',
          贵: 'G',
          桂: 'G',
          滚: 'G',
          郭: 'G',
          国: 'G',
          果: 'G',
          过: 'G',
          // H
          哈: 'H',
          孩: 'H',
          海: 'H',
          害: 'H',
          寒: 'H',
          韩: 'H',
          汉: 'H',
          汗: 'H',
          杭: 'H',
          航: 'H',
          毫: 'H',
          好: 'H',
          号: 'H',
          浩: 'H',
          耗: 'H',
          何: 'H',
          河: 'H',
          和: 'H',
          核: 'H',
          荷: 'H',
          贺: 'H',
          赫: 'H',
          褐: 'H',
          鹤: 'H',
          黑: 'H',
          痕: 'H',
          很: 'H',
          狠: 'H',
          恨: 'H',
          恒: 'H',
          横: 'H',
          衡: 'H',
          轰: 'H',
          哄: 'H',
          红: 'H',
          宏: 'H',
          洪: 'H',
          虹: 'H',
          侯: 'H',
          喉: 'H',
          猴: 'H',
          吼: 'H',
          后: 'H',
          厚: 'H',
          候: 'H',
          乎: 'H',
          呼: 'H',
          忽: 'H',
          狐: 'H',
          胡: 'H',
          壶: 'H',
          湖: 'H',
          葫: 'H',
          糊: 'H',
          蝴: 'H',
          虎: 'H',
          互: 'H',
          户: 'H',
          护: 'H',
          花: 'H',
          华: 'H',
          划: 'H',
          化: 'H',
          划: 'H',
          怀: 'H',
          淮: 'H',
          坏: 'H',
          欢: 'H',
          还: 'H',
          环: 'H',
          缓: 'H',
          幻: 'H',
          换: 'H',
          唤: 'H',
          患: 'H',
          荒: 'H',
          皇: 'H',
          黄: 'H',
          煌: 'H',
          晃: 'H',
          灰: 'H',
          恢: 'H',
          挥: 'H',
          辉: 'H',
          回: 'H',
          毁: 'H',
          悔: 'H',
          汇: 'H',
          会: 'H',
          绘: 'H',
          婚: 'H',
          浑: 'H',
          魂: 'H',
          混: 'H',
          活: 'H',
          火: 'H',
          伙: 'H',
          或: 'H',
          货: 'H',
          获: 'H',
          祸: 'H',
          惑: 'H',
          霍: 'H',
          // J
          机: 'J',
          鸡: 'J',
          积: 'J',
          基: 'J',
          激: 'J',
          及: 'J',
          吉: 'J',
          级: 'J',
          即: 'J',
          极: 'J',
          急: 'J',
          疾: 'J',
          集: 'J',
          籍: 'J',
          辑: 'J',
          籍: 'J',
          几: 'J',
          己: 'J',
          挤: 'J',
          济: 'J',
          计: 'J',
          记: 'J',
          纪: 'J',
          技: 'J',
          际: 'J',
          季: 'J',
          剂: 'J',
          济: 'J',
          既: 'J',
          继: 'J',
          寄: 'J',
          加: 'J',
          夹: 'J',
          佳: 'J',
          家: 'J',
          嘉: 'J',
          甲: 'J',
          价: 'J',
          驾: 'J',
          架: 'J',
          假: 'J',
          嫁: 'J',
          歼: 'J',
          坚: 'J',
          间: 'J',
          艰: 'J',
          肩: 'J',
          监: 'J',
          兼: 'J',
          煎: 'J',
          拣: 'J',
          俭: 'J',
          茧: 'J',
          捡: 'J',
          减: 'J',
          剪: 'J',
          检: 'J',
          简: 'J',
          见: 'J',
          件: 'J',
          建: 'J',
          剑: 'J',
          荐: 'J',
          贱: 'J',
          健: 'J',
          舰: 'J',
          渐: 'J',
          践: 'J',
          鉴: 'J',
          键: 'J',
          江: 'J',
          将: 'J',
          姜: 'J',
          浆: 'J',
          僵: 'J',
          疆: 'J',
          讲: 'J',
          奖: 'J',
          匠: 'J',
          降: 'J',
          交: 'J',
          郊: 'J',
          娇: 'J',
          浇: 'J',
          骄: 'J',
          胶: 'J',
          教: 'J',
          焦: 'J',
          蕉: 'J',
          礁: 'J',
          嚼: 'J',
          角: 'J',
          饺: 'J',
          脚: 'J',
          搅: 'J',
          缴: 'J',
          叫: 'J',
          较: 'J',
          教: 'J',
          阶: 'J',
          皆: 'J',
          接: 'J',
          揭: 'J',
          街: 'J',
          节: 'J',
          劫: 'J',
          杰: 'J',
          洁: 'J',
          结: 'J',
          捷: 'J',
          截: 'J',
          竭: 'J',
          姐: 'J',
          解: 'J',
          介: 'J',
          戒: 'J',
          届: 'J',
          界: 'J',
          借: 'J',
          巾: 'J',
          今: 'J',
          金: 'J',
          津: 'J',
          筋: 'J',
          斤: 'J',
          仅: 'J',
          紧: 'J',
          锦: 'J',
          尽: 'J',
          劲: 'J',
          近: 'J',
          进: 'J',
          晋: 'J',
          浸: 'J',
          尽: 'J',
          京: 'J',
          经: 'J',
          茎: 'J',
          惊: 'J',
          晶: 'J',
          睛: 'J',
          精: 'J',
          井: 'J',
          颈: 'J',
          景: 'J',
          警: 'J',
          净: 'J',
          静: 'J',
          境: 'J',
          敬: 'J',
          镜: 'J',
          纠: 'J',
          究: 'J',
          揪: 'J',
          九: 'J',
          久: 'J',
          酒: 'J',
          旧: 'J',
          救: 'J',
          就: 'J',
          舅: 'J',
          居: 'J',
          拘: 'J',
          驹: 'J',
          鞠: 'J',
          局: 'J',
          菊: 'J',
          橘: 'J',
          举: 'J',
          矩: 'J',
          句: 'J',
          巨: 'J',
          拒: 'J',
          具: 'J',
          俱: 'J',
          剧: 'J',
          惧: 'J',
          据: 'J',
          距: 'J',
          锯: 'J',
          聚: 'J',
          捐: 'J',
          卷: 'J',
          决: 'J',
          绝: 'J',
          觉: 'J',
          掘: 'J',
          嚼: 'J',
          军: 'J',
          君: 'J',
          均: 'J',
          菌: 'J',
          俊: 'J',
          // K
          卡: 'K',
          开: 'K',
          凯: 'K',
          慨: 'K',
          刊: 'K',
          堪: 'K',
          砍: 'K',
          看: 'K',
          康: 'K',
          慷: 'K',
          扛: 'K',
          亢: 'K',
          抗: 'K',
          炕: 'K',
          考: 'K',
          烤: 'K',
          靠: 'K',
          科: 'K',
          棵: 'K',
          颗: 'K',
          科: 'K',
          壳: 'K',
          咳: 'K',
          可: 'K',
          渴: 'K',
          克: 'K',
          刻: 'K',
          客: 'K',
          课: 'K',
          肯: 'K',
          垦: 'K',
          恳: 'K',
          坑: 'K',
          空: 'K',
          孔: 'K',
          恐: 'K',
          控: 'K',
          口: 'K',
          扣: 'K',
          寇: 'K',
          枯: 'K',
          哭: 'K',
          苦: 'K',
          库: 'K',
          裤: 'K',
          酷: 'K',
          夸: 'K',
          垮: 'K',
          挎: 'K',
          跨: 'K',
          块: 'K',
          快: 'K',
          宽: 'K',
          款: 'K',
          狂: 'K',
          况: 'K',
          矿: 'K',
          框: 'K',
          亏: 'K',
          葵: 'K',
          愧: 'K',
          溃: 'K',
          坤: 'K',
          昆: 'K',
          捆: 'K',
          困: 'K',
          扩: 'K',
          括: 'K',
          // L
          垃: 'L',
          拉: 'L',
          啦: 'L',
          腊: 'L',
          辣: 'L',
          来: 'L',
          赖: 'L',
          兰: 'L',
          栏: 'L',
          蓝: 'L',
          览: 'L',
          懒: 'L',
          烂: 'L',
          滥: 'L',
          郎: 'L',
          狼: 'L',
          廊: 'L',
          朗: 'L',
          浪: 'L',
          捞: 'L',
          劳: 'L',
          牢: 'L',
          老: 'L',
          姥: 'L',
          涝: 'L',
          乐: 'L',
          勒: 'L',
          雷: 'L',
          垒: 'L',
          累: 'L',
          泪: 'L',
          类: 'L',
          冷: 'L',
          愣: 'L',
          黎: 'L',
          礼: 'L',
          李: 'L',
          里: 'L',
          理: 'L',
          鲤: 'L',
          力: 'L',
          历: 'L',
          厉: 'L',
          立: 'L',
          丽: 'L',
          利: 'L',
          励: 'L',
          例: 'L',
          隶: 'L',
          栗: 'L',
          粒: 'L',
          俩: 'L',
          连: 'L',
          帘: 'L',
          怜: 'L',
          莲: 'L',
          联: 'L',
          廉: 'L',
          镰: 'L',
          脸: 'L',
          练: 'L',
          炼: 'L',
          恋: 'L',
          良: 'L',
          凉: 'L',
          梁: 'L',
          粮: 'L',
          两: 'L',
          亮: 'L',
          谅: 'L',
          辆: 'L',
          量: 'L',
          辽: 'L',
          疗: 'L',
          聊: 'L',
          僚: 'L',
          寥: 'L',
          了: 'L',
          料: 'L',
          列: 'L',
          劣: 'L',
          烈: 'L',
          猎: 'L',
          裂: 'L',
          林: 'L',
          临: 'L',
          淋: 'L',
          磷: 'L',
          灵: 'L',
          玲: 'L',
          凌: 'L',
          铃: 'L',
          陵: 'L',
          领: 'L',
          岭: 'L',
          令: 'L',
          溜: 'L',
          刘: 'L',
          流: 'L',
          留: 'L',
          硫: 'L',
          榴: 'L',
          柳: 'L',
          六: 'L',
          龙: 'L',
          聋: 'L',
          笼: 'L',
          隆: 'L',
          垄: 'L',
          拢: 'L',
          楼: 'L',
          漏: 'L',
          露: 'L',
          卢: 'L',
          芦: 'L',
          炉: 'L',
          鲁: 'L',
          陆: 'L',
          录: 'L',
          鹿: 'L',
          滤: 'L',
          碌: 'L',
          路: 'L',
          露: 'L',
          驴: 'L',
          旅: 'L',
          铝: 'L',
          律: 'L',
          虑: 'L',
          率: 'L',
          绿: 'L',
          氯: 'L',
          卵: 'L',
          乱: 'L',
          掠: 'L',
          略: 'L',
          伦: 'L',
          轮: 'L',
          论: 'L',
          罗: 'L',
          萝: 'L',
          逻: 'L',
          锣: 'L',
          箩: 'L',
          骡: 'L',
          螺: 'L',
          裸: 'L',
          洛: 'L',
          络: 'L',
          骆: 'L',
          落: 'L',
          // M
          妈: 'M',
          麻: 'M',
          马: 'M',
          码: 'M',
          蚂: 'M',
          骂: 'M',
          吗: 'M',
          埋: 'M',
          买: 'M',
          迈: 'M',
          麦: 'M',
          卖: 'M',
          脉: 'M',
          蛮: 'M',
          满: 'M',
          曼: 'M',
          慢: 'M',
          漫: 'M',
          忙: 'M',
          芒: 'M',
          盲: 'M',
          茫: 'M',
          莽: 'M',
          猫: 'M',
          毛: 'M',
          矛: 'M',
          茅: 'M',
          茂: 'M',
          冒: 'M',
          贸: 'M',
          帽: 'M',
          貌: 'M',
          么: 'M',
          没: 'M',
          枚: 'M',
          玫: 'M',
          眉: 'M',
          梅: 'M',
          媒: 'M',
          煤: 'M',
          霉: 'M',
          每: 'M',
          美: 'M',
          妹: 'M',
          昧: 'M',
          门: 'M',
          闷: 'M',
          们: 'M',
          蒙: 'M',
          盟: 'M',
          猛: 'M',
          梦: 'M',
          孟: 'M',
          迷: 'M',
          谜: 'M',
          米: 'M',
          泌: 'M',
          秘: 'M',
          密: 'M',
          蜜: 'M',
          眠: 'M',
          绵: 'M',
          棉: 'M',
          免: 'M',
          勉: 'M',
          缅: 'M',
          面: 'M',
          苗: 'M',
          描: 'M',
          瞄: 'M',
          秒: 'M',
          妙: 'M',
          庙: 'M',
          灭: 'M',
          蔑: 'M',
          民: 'M',
          敏: 'M',
          名: 'M',
          明: 'M',
          鸣: 'M',
          命: 'M',
          摸: 'M',
          模: 'M',
          膜: 'M',
          摩: 'M',
          磨: 'M',
          蘑: 'M',
          魔: 'M',
          抹: 'M',
          末: 'M',
          沫: 'M',
          陌: 'M',
          莫: 'M',
          漠: 'M',
          寞: 'M',
          墨: 'M',
          默: 'M',
          谋: 'M',
          某: 'M',
          母: 'M',
          亩: 'M',
          牡: 'M',
          姆: 'M',
          拇: 'M',
          木: 'M',
          目: 'M',
          牧: 'M',
          墓: 'M',
          幕: 'M',
          慕: 'M',
          暮: 'M',
          穆: 'M',
          // N
          拿: 'N',
          哪: 'N',
          内: 'N',
          那: 'N',
          纳: 'N',
          钠: 'N',
          乃: 'N',
          奶: 'N',
          奈: 'N',
          耐: 'N',
          男: 'N',
          南: 'N',
          难: 'N',
          囊: 'N',
          挠: 'N',
          恼: 'N',
          脑: 'N',
          闹: 'N',
          呢: 'N',
          馁: 'N',
          嫩: 'N',
          能: 'N',
          尼: 'N',
          泥: 'N',
          你: 'N',
          拟: 'N',
          逆: 'N',
          年: 'N',
          念: 'N',
          娘: 'N',
          酿: 'N',
          鸟: 'N',
          尿: 'N',
          捏: 'N',
          聂: 'N',
          宁: 'N',
          凝: 'N',
          牛: 'N',
          扭: 'N',
          纽: 'N',
          浓: 'N',
          农: 'N',
          弄: 'N',
          奴: 'N',
          努: 'N',
          怒: 'N',
          女: 'N',
          暖: 'N',
          虐: 'N',
          挪: 'N',
          懦: 'N',
          糯: 'N',
          // O
          欧: 'O',
          殴: 'O',
          鸥: 'O',
          偶: 'O',
          // P
          趴: 'P',
          啪: 'P',
          爬: 'P',
          怕: 'P',
          拍: 'P',
          排: 'P',
          牌: 'P',
          派: 'P',
          攀: 'P',
          盘: 'P',
          判: 'P',
          叛: 'P',
          盼: 'P',
          乓: 'P',
          旁: 'P',
          庞: 'P',
          胖: 'P',
          抛: 'P',
          刨: 'P',
          炮: 'P',
          袍: 'P',
          跑: 'P',
          泡: 'P',
          呸: 'P',
          胚: 'P',
          陪: 'P',
          培: 'P',
          赔: 'P',
          佩: 'P',
          配: 'P',
          喷: 'P',
          盆: 'P',
          朋: 'P',
          棚: 'P',
          蓬: 'P',
          鹏: 'P',
          捧: 'P',
          碰: 'P',
          批: 'P',
          披: 'P',
          劈: 'P',
          皮: 'P',
          疲: 'P',
          脾: 'P',
          匹: 'P',
          痞: 'P',
          僻: 'P',
          片: 'P',
          偏: 'P',
          篇: 'P',
          骗: 'P',
          漂: 'P',
          飘: 'P',
          票: 'P',
          撇: 'P',
          拼: 'P',
          贫: 'P',
          品: 'P',
          聘: 'P',
          乒: 'P',
          平: 'P',
          评: 'P',
          凭: 'P',
          苹: 'P',
          屏: 'P',
          瓶: 'P',
          坡: 'P',
          泼: 'P',
          颇: 'P',
          婆: 'P',
          迫: 'P',
          破: 'P',
          魄: 'P',
          剖: 'P',
          仆: 'P',
          扑: 'P',
          铺: 'P',
          葡: 'P',
          蒲: 'P',
          朴: 'P',
          圃: 'P',
          浦: 'P',
          普: 'P',
          谱: 'P',
          // Q
          七: 'Q',
          妻: 'Q',
          戚: 'Q',
          欺: 'Q',
          漆: 'Q',
          齐: 'Q',
          其: 'Q',
          奇: 'Q',
          歧: 'Q',
          骑: 'Q',
          棋: 'Q',
          旗: 'Q',
          乞: 'Q',
          企: 'Q',
          岂: 'Q',
          启: 'Q',
          起: 'Q',
          气: 'Q',
          讫: 'Q',
          迄: 'Q',
          弃: 'Q',
          汽: 'Q',
          砌: 'Q',
          器: 'Q',
          恰: 'Q',
          洽: 'Q',
          千: 'Q',
          迁: 'Q',
          牵: 'Q',
          铅: 'Q',
          谦: 'Q',
          签: 'Q',
          前: 'Q',
          钱: 'Q',
          钳: 'Q',
          乾: 'Q',
          潜: 'Q',
          浅: 'Q',
          遣: 'Q',
          谴: 'Q',
          欠: 'Q',
          枪: 'Q',
          腔: 'Q',
          强: 'Q',
          墙: 'Q',
          抢: 'Q',
          悄: 'Q',
          敲: 'Q',
          锹: 'Q',
          乔: 'Q',
          侨: 'Q',
          桥: 'Q',
          瞧: 'Q',
          巧: 'Q',
          俏: 'Q',
          切: 'Q',
          且: 'Q',
          窃: 'Q',
          亲: 'Q',
          侵: 'Q',
          钦: 'Q',
          琴: 'Q',
          禽: 'Q',
          勤: 'Q',
          擒: 'Q',
          寝: 'Q',
          沁: 'Q',
          青: 'Q',
          轻: 'Q',
          氢: 'Q',
          倾: 'Q',
          卿: 'Q',
          清: 'Q',
          蜻: 'Q',
          情: 'Q',
          晴: 'Q',
          擎: 'Q',
          顷: 'Q',
          请: 'Q',
          庆: 'Q',
          穷: 'Q',
          琼: 'Q',
          丘: 'Q',
          秋: 'Q',
          蚯: 'Q',
          求: 'Q',
          球: 'Q',
          区: 'Q',
          曲: 'Q',
          驱: 'Q',
          屈: 'Q',
          躯: 'Q',
          趋: 'Q',
          渠: 'Q',
          取: 'Q',
          娶: 'Q',
          去: 'Q',
          趣: 'Q',
          圈: 'Q',
          权: 'Q',
          全: 'Q',
          泉: 'Q',
          拳: 'Q',
          犬: 'Q',
          劝: 'Q',
          券: 'Q',
          缺: 'Q',
          却: 'Q',
          鹊: 'Q',
          确: 'Q',
          裙: 'Q',
          群: 'Q',
          // R
          然: 'R',
          燃: 'R',
          染: 'R',
          嚷: 'R',
          壤: 'R',
          让: 'R',
          饶: 'R',
          扰: 'R',
          绕: 'R',
          惹: 'R',
          热: 'R',
          人: 'R',
          仁: 'R',
          忍: 'R',
          认: 'R',
          任: 'R',
          刃: 'R',
          纫: 'R',
          扔: 'R',
          仍: 'R',
          日: 'R',
          荣: 'R',
          绒: 'R',
          容: 'R',
          熔: 'R',
          溶: 'R',
          蓉: 'R',
          融: 'R',
          冗: 'R',
          柔: 'R',
          肉: 'R',
          如: 'R',
          儒: 'R',
          孺: 'R',
          辱: 'R',
          乳: 'R',
          入: 'R',
          软: 'R',
          锐: 'R',
          瑞: 'R',
          润: 'R',
          若: 'R',
          弱: 'R',
          // S
          撒: 'S',
          洒: 'S',
          塞: 'S',
          腮: 'S',
          赛: 'S',
          三: 'S',
          伞: 'S',
          散: 'S',
          桑: 'S',
          嗓: 'S',
          丧: 'S',
          搔: 'S',
          骚: 'S',
          扫: 'S',
          嫂: 'S',
          色: 'S',
          涩: 'S',
          森: 'S',
          僧: 'S',
          杀: 'S',
          沙: 'S',
          纱: 'S',
          刹: 'S',
          砂: 'S',
          傻: 'S',
          煞: 'S',
          厦: 'S',
          筛: 'S',
          晒: 'S',
          山: 'S',
          杉: 'S',
          衫: 'S',
          删: 'S',
          闪: 'S',
          陕: 'S',
          扇: 'S',
          善: 'S',
          擅: 'S',
          膳: 'S',
          赡: 'S',
          伤: 'S',
          商: 'S',
          裳: 'S',
          晌: 'S',
          赏: 'S',
          上: 'S',
          尚: 'S',
          捎: 'S',
          梢: 'S',
          烧: 'S',
          稍: 'S',
          勺: 'S',
          少: 'S',
          绍: 'S',
          哨: 'S',
          奢: 'S',
          舌: 'S',
          蛇: 'S',
          舍: 'S',
          设: 'S',
          社: 'S',
          射: 'S',
          涉: 'S',
          摄: 'S',
          申: 'S',
          伸: 'S',
          身: 'S',
          深: 'S',
          神: 'S',
          审: 'S',
          婶: 'S',
          肾: 'S',
          甚: 'S',
          渗: 'S',
          慎: 'S',
          升: 'S',
          生: 'S',
          声: 'S',
          牲: 'S',
          胜: 'S',
          绳: 'S',
          省: 'S',
          圣: 'S',
          剩: 'S',
          尸: 'S',
          失: 'S',
          师: 'S',
          诗: 'S',
          狮: 'S',
          施: 'S',
          湿: 'S',
          十: 'S',
          什: 'S',
          石: 'S',
          时: 'S',
          识: 'S',
          实: 'S',
          拾: 'S',
          食: 'S',
          蚀: 'S',
          史: 'S',
          使: 'S',
          始: 'S',
          驶: 'S',
          士: 'S',
          氏: 'S',
          世: 'S',
          市: 'S',
          示: 'S',
          式: 'S',
          事: 'S',
          侍: 'S',
          势: 'S',
          视: 'S',
          试: 'S',
          饰: 'S',
          室: 'S',
          是: 'S',
          适: 'S',
          逝: 'S',
          释: 'S',
          誓: 'S',
          收: 'S',
          手: 'S',
          守: 'S',
          首: 'S',
          寿: 'S',
          受: 'S',
          兽: 'S',
          售: 'S',
          授: 'S',
          瘦: 'S',
          书: 'S',
          抒: 'S',
          枢: 'S',
          叔: 'S',
          殊: 'S',
          梳: 'S',
          淑: 'S',
          疏: 'S',
          舒: 'S',
          输: 'S',
          蔬: 'S',
          熟: 'S',
          暑: 'S',
          黍: 'S',
          署: 'S',
          蜀: 'S',
          鼠: 'S',
          属: 'S',
          术: 'S',
          束: 'S',
          述: 'S',
          树: 'S',
          竖: 'S',
          恕: 'S',
          庶: 'S',
          数: 'S',
          刷: 'S',
          耍: 'S',
          衰: 'S',
          摔: 'S',
          甩: 'S',
          帅: 'S',
          拴: 'S',
          霜: 'S',
          双: 'S',
          爽: 'S',
          谁: 'S',
          水: 'S',
          税: 'S',
          睡: 'S',
          顺: 'S',
          瞬: 'S',
          说: 'S',
          烁: 'S',
          朔: 'S',
          硕: 'S',
          丝: 'S',
          司: 'S',
          私: 'S',
          思: 'S',
          斯: 'S',
          死: 'S',
          四: 'S',
          寺: 'S',
          似: 'S',
          饲: 'S',
          松: 'S',
          怂: 'S',
          耸: 'S',
          送: 'S',
          颂: 'S',
          诵: 'S',
          搜: 'S',
          艘: 'S',
          苏: 'S',
          俗: 'S',
          诉: 'S',
          肃: 'S',
          素: 'S',
          速: 'S',
          宿: 'S',
          塑: 'S',
          溯: 'S',
          // T
          他: 'T',
          它: 'T',
          她: 'T',
          塌: 'T',
          踏: 'T',
          塔: 'T',
          獭: 'T',
          蹋: 'T',
          胎: 'T',
          台: 'T',
          抬: 'T',
          苔: 'T',
          太: 'T',
          汰: 'T',
          态: 'T',
          泰: 'T',
          贪: 'T',
          摊: 'T',
          滩: 'T',
          瘫: 'T',
          坛: 'T',
          谈: 'T',
          痰: 'T',
          潭: 'T',
          檀: 'T',
          坦: 'T',
          叹: 'T',
          炭: 'T',
          探: 'T',
          碳: 'T',
          汤: 'T',
          唐: 'T',
          堂: 'T',
          塘: 'T',
          糖: 'T',
          倘: 'T',
          淌: 'T',
          躺: 'T',
          烫: 'T',
          涛: 'T',
          掏: 'T',
          滔: 'T',
          逃: 'T',
          桃: 'T',
          陶: 'T',
          萄: 'T',
          淘: 'T',
          讨: 'T',
          套: 'T',
          特: 'T',
          疼: 'T',
          腾: 'T',
          藤: 'T',
          梯: 'T',
          踢: 'T',
          啼: 'T',
          提: 'T',
          题: 'T',
          蹄: 'T',
          体: 'T',
          替: 'T',
          天: 'T',
          添: 'T',
          田: 'T',
          填: 'T',
          甜: 'T',
          舔: 'T',
          挑: 'T',
          条: 'T',
          迢: 'T',
          跳: 'T',
          贴: 'T',
          铁: 'T',
          帖: 'T',
          厅: 'T',
          听: 'T',
          廷: 'T',
          亭: 'T',
          庭: 'T',
          停: 'T',
          挺: 'T',
          艇: 'T',
          通: 'T',
          同: 'T',
          彤: 'T',
          桐: 'T',
          铜: 'T',
          童: 'T',
          统: 'T',
          桶: 'T',
          筒: 'T',
          痛: 'T',
          偷: 'T',
          头: 'T',
          投: 'T',
          透: 'T',
          凸: 'T',
          秃: 'T',
          突: 'T',
          图: 'T',
          徒: 'T',
          涂: 'T',
          途: 'T',
          屠: 'T',
          土: 'T',
          吐: 'T',
          兔: 'T',
          团: 'T',
          推: 'T',
          颓: 'T',
          腿: 'T',
          退: 'T',
          吞: 'T',
          屯: 'T',
          托: 'T',
          拖: 'T',
          脱: 'T',
          驮: 'T',
          陀: 'T',
          驼: 'T',
          妥: 'T',
          拓: 'T',
          唾: 'T',
          // W
          挖: 'W',
          哇: 'W',
          蛙: 'W',
          娃: 'W',
          瓦: 'W',
          袜: 'W',
          歪: 'W',
          外: 'W',
          弯: 'W',
          湾: 'W',
          丸: 'W',
          完: 'W',
          玩: 'W',
          顽: 'W',
          挽: 'W',
          晚: 'W',
          碗: 'W',
          万: 'W',
          汪: 'W',
          亡: 'W',
          王: 'W',
          网: 'W',
          往: 'W',
          枉: 'W',
          妄: 'W',
          忘: 'W',
          旺: 'W',
          望: 'W',
          危: 'W',
          威: 'W',
          微: 'W',
          为: 'W',
          围: 'W',
          违: 'W',
          唯: 'W',
          惟: 'W',
          维: 'W',
          伟: 'W',
          伪: 'W',
          尾: 'W',
          纬: 'W',
          委: 'W',
          卫: 'W',
          未: 'W',
          位: 'W',
          味: 'W',
          畏: 'W',
          胃: 'W',
          谓: 'W',
          喂: 'W',
          尉: 'W',
          蔚: 'W',
          慰: 'W',
          魏: 'W',
          温: 'W',
          文: 'W',
          纹: 'W',
          蚊: 'W',
          闻: 'W',
          吻: 'W',
          稳: 'W',
          问: 'W',
          翁: 'W',
          窝: 'W',
          我: 'W',
          沃: 'W',
          卧: 'W',
          握: 'W',
          乌: 'W',
          污: 'W',
          呜: 'W',
          巫: 'W',
          诬: 'W',
          屋: 'W',
          无: 'W',
          吴: 'W',
          吾: 'W',
          梧: 'W',
          蜈: 'W',
          五: 'W',
          午: 'W',
          伍: 'W',
          武: 'W',
          侮: 'W',
          捂: 'W',
          鹉: 'W',
          舞: 'W',
          勿: 'W',
          戊: 'W',
          务: 'W',
          物: 'W',
          误: 'W',
          悟: 'W',
          晤: 'W',
          雾: 'W',
          夕: 'W',
          西: 'X',
          吸: 'X',
          希: 'X',
          昔: 'X',
          // X
          析: 'X',
          牺: 'X',
          息: 'X',
          惜: 'X',
          悉: 'X',
          蟋: 'X',
          锡: 'X',
          熙: 'X',
          嘻: 'X',
          嬉: 'X',
          膝: 'X',
          习: 'X',
          席: 'X',
          袭: 'X',
          媳: 'X',
          洗: 'X',
          喜: 'X',
          戏: 'X',
          系: 'X',
          细: 'X',
          隙: 'X',
          虾: 'X',
          瞎: 'X',
          峡: 'X',
          狭: 'X',
          匣: 'X',
          霞: 'X',
          辖: 'X',
          暇: 'X',
          下: 'X',
          夏: 'X',
          吓: 'X',
          掀: 'X',
          先: 'X',
          仙: 'X',
          纤: 'X',
          鲜: 'X',
          闲: 'X',
          贤: 'X',
          咸: 'X',
          涎: 'X',
          衔: 'X',
          嫌: 'X',
          显: 'X',
          险: 'X',
          县: 'X',
          现: 'X',
          限: 'X',
          线: 'X',
          宪: 'X',
          陷: 'X',
          馅: 'X',
          羡: 'X',
          献: 'X',
          腺: 'X',
          乡: 'X',
          相: 'X',
          香: 'X',
          厢: 'X',
          湘: 'X',
          箱: 'B',
          详: 'X',
          祥: 'X',
          翔: 'X',
          享: 'X',
          响: 'X',
          想: 'X',
          向: 'X',
          巷: 'X',
          项: 'X',
          象: 'X',
          像: 'X',
          橡: 'X',
          削: 'X',
          消: 'X',
          宵: 'X',
          硝: 'X',
          霄: 'X',
          嚣: 'X',
          小: 'X',
          晓: 'X',
          孝: 'X',
          效: 'X',
          校: 'X',
          笑: 'X',
          些: 'X',
          歇: 'X',
          协: 'X',
          邪: 'X',
          胁: 'X',
          斜: 'X',
          谐: 'X',
          携: 'X',
          鞋: 'X',
          写: 'X',
          泄: 'X',
          泻: 'X',
          卸: 'X',
          屑: 'X',
          械: 'X',
          谢: 'X',
          懈: 'X',
          蟹: 'X',
          心: 'X',
          辛: 'X',
          欣: 'X',
          新: 'X',
          薪: 'X',
          信: 'X',
          兴: 'X',
          星: 'X',
          腥: 'X',
          刑: 'X',
          行: 'X',
          形: 'X',
          型: 'X',
          醒: 'X',
          杏: 'X',
          姓: 'X',
          幸: 'X',
          性: 'X',
          凶: 'X',
          兄: 'X',
          匈: 'X',
          汹: 'X',
          胸: 'X',
          雄: 'X',
          熊: 'X',
          休: 'X',
          修: 'X',
          羞: 'X',
          朽: 'X',
          秀: 'X',
          袖: 'X',
          锈: 'X',
          嗅: 'X',
          虚: 'X',
          需: 'X',
          徐: 'X',
          许: 'X',
          序: 'X',
          叙: 'X',
          畜: 'X',
          绪: 'X',
          续: 'X',
          絮: 'X',
          婿: 'X',
          蓄: 'X',
          宣: 'X',
          悬: 'X',
          旋: 'X',
          选: 'X',
          癣: 'X',
          炫: 'X',
          眩: 'X',
          绚: 'X',
          靴: 'X',
          学: 'X',
          穴: 'X',
          雪: 'X',
          血: 'X',
          勋: 'X',
          熏: 'X',
          寻: 'X',
          巡: 'X',
          旬: 'X',
          驯: 'X',
          询: 'X',
          循: 'X',
          训: 'X',
          讯: 'X',
          汛: 'X',
          迅: 'X',
          压: 'Y',
          呀: 'Y',
          鸦: 'Y',
          鸭: 'Y',
          牙: 'Y',
          芽: 'Y',
          蚜: 'Y',
          // Y
          崖: 'Y',
          涯: 'Y',
          衙: 'Y',
          雅: 'Y',
          亚: 'Y',
          咽: 'Y',
          烟: 'Y',
          淹: 'Y',
          盐: 'Y',
          严: 'Y',
          言: 'Y',
          岩: 'Y',
          炎: 'Y',
          沿: 'Y',
          研: 'Y',
          盐: 'Y',
          蜒: 'Y',
          颜: 'Y',
          掩: 'Y',
          眼: 'Y',
          演: 'Y',
          厌: 'Y',
          宴: 'Y',
          艳: 'Y',
          验: 'Y',
          谚: 'Y',
          焰: 'Y',
          雁: 'Y',
          燕: 'Y',
          央: 'Y',
          扬: 'Y',
          羊: 'Y',
          阳: 'Y',
          杨: 'Y',
          佯: 'Y',
          洋: 'Y',
          仰: 'Y',
          养: 'Y',
          氧: 'Y',
          痒: 'Y',
          样: 'Y',
          夭: 'Y',
          妖: 'Y',
          腰: 'Y',
          邀: 'Y',
          窑: 'Y',
          谣: 'Y',
          摇: 'Y',
          遥: 'Y',
          肴: 'Y',
          姚: 'Y',
          咬: 'Y',
          舀: 'Y',
          药: 'Y',
          要: 'Y',
          耀: 'Y',
          爷: 'Y',
          耶: 'Y',
          野: 'Y',
          也: 'Y',
          冶: 'Y',
          页: 'Y',
          夜: 'Y',
          液: 'Y',
          一: 'Y',
          衣: 'Y',
          医: 'Y',
          依: 'Y',
          伊: 'Y',
          揖: 'Y',
          仪: 'Y',
          夷: 'Y',
          宜: 'Y',
          移: 'Y',
          遗: 'Y',
          疑: 'Y',
          乙: 'Y',
          已: 'Y',
          以: 'Y',
          矣: 'Y',
          蚁: 'Y',
          椅: 'Y',
          义: 'Y',
          亿: 'Y',
          忆: 'Y',
          艺: 'Y',
          议: 'Y',
          亦: 'Y',
          异: 'Y',
          役: 'Y',
          抑: 'Y',
          译: 'Y',
          易: 'Y',
          疫: 'Y',
          益: 'Y',
          谊: 'Y',
          逸: 'Y',
          意: 'Y',
          溢: 'Y',
          毅: 'Y',
          翼: 'Y',
          因: 'Y',
          阴: 'Y',
          音: 'Y',
          姻: 'Y',
          吟: 'Y',
          银: 'Y',
          引: 'Y',
          饮: 'Y',
          隐: 'Y',
          印: 'Y',
          应: 'Y',
          英: 'Y',
          婴: 'Y',
          樱: 'Y',
          鹰: 'Y',
          迎: 'Y',
          盈: 'Y',
          营: 'Y',
          蝇: 'Y',
          赢: 'Y',
          影: 'Y',
          映: 'Y',
          硬: 'Y',
          哟: 'Y',
          拥: 'Y',
          佣: 'Y',
          痈: 'Y',
          庸: 'Y',
          雍: 'Y',
          永: 'Y',
          泳: 'Y',
          勇: 'Y',
          涌: 'Y',
          用: 'Y',
          优: 'Y',
          忧: 'Y',
          悠: 'Y',
          尤: 'Y',
          由: 'Y',
          犹: 'Y',
          邮: 'Y',
          油: 'Y',
          游: 'Y',
          友: 'Y',
          有: 'Y',
          又: 'Y',
          右: 'Y',
          幼: 'Y',
          诱: 'Y',
          于: 'Y',
          予: 'Y',
          余: 'Y',
          鱼: 'Y',
          娱: 'Y',
          渔: 'Y',
          愉: 'Y',
          愚: 'Y',
          榆: 'Y',
          与: 'Y',
          宇: 'Y',
          羽: 'Y',
          雨: 'Y',
          语: 'Y',
          玉: 'Y',
          驭: 'Y',
          芋: 'Y',
          育: 'Y',
          郁: 'Y',
          狱: 'Y',
          浴: 'Y',
          预: 'Y',
          域: 'Y',
          欲: 'Y',
          喻: 'Y',
          寓: 'Y',
          御: 'Y',
          裕: 'Y',
          遇: 'Y',
          愈: 'Y',
          誉: 'Y',
          豫: 'Y',
          冤: 'Y',
          元: 'Y',
          园: 'Y',
          员: 'Y',
          原: 'Y',
          圆: 'Y',
          袁: 'Y',
          援: 'Y',
          缘: 'Y',
          源: 'Y',
          猿: 'Y',
          远: 'Y',
          怨: 'Y',
          院: 'Y',
          愿: 'Y',
          曰: 'Y',
          约: 'Y',
          月: 'Y',
          岳: 'Y',
          悦: 'Y',
          阅: 'Y',
          跃: 'Y',
          越: 'Y',
          云: 'Y',
          匀: 'Y',
          允: 'Y',
          孕: 'Y',
          运: 'Y',
          酝: 'Y',
          晕: 'Y',
          韵: 'Y',
          蕴: 'Y',
          // Z
          杂: 'Z',
          砸: 'Z',
          灾: 'Z',
          栽: 'Z',
          宰: 'Z',
          载: 'Z',
          再: 'Z',
          在: 'Z',
          咱: 'Z',
          攒: 'Z',
          暂: 'Z',
          赞: 'Z',
          赃: 'Z',
          脏: 'Z',
          葬: 'Z',
          遭: 'Z',
          糟: 'Z',
          凿: 'Z',
          早: 'Z',
          枣: 'Z',
          蚤: 'Z',
          澡: 'Z',
          藻: 'Z',
          灶: 'Z',
          皂: 'Z',
          造: 'Z',
          噪: 'Z',
          燥: 'Z',
          躁: 'Z',
          则: 'Z',
          责: 'Z',
          贼: 'Z',
          怎: 'Z',
          增: 'Z',
          憎: 'Z',
          赠: 'Z',
          扎: 'Z',
          渣: 'Z',
          札: 'Z',
          轧: 'Z',
          闸: 'Z',
          炸: 'Z',
          诈: 'Z',
          榨: 'Z',
          摘: 'Z',
          宅: 'Z',
          窄: 'Z',
          债: 'Z',
          寨: 'Z',
          沾: 'Z',
          展: 'Z',
          斩: 'Z',
          盏: 'Z',
          崭: 'Z',
          占: 'Z',
          战: 'Z',
          站: 'Z',
          绽: 'Z',
          章: 'Z',
          张: 'Z',
          彰: 'Z',
          樟: 'Z',
          涨: 'Z',
          掌: 'Z',
          丈: 'Z',
          仗: 'Z',
          帐: 'Z',
          账: 'Z',
          胀: 'Z',
          障: 'Z',
          招: 'Z',
          找: 'Z',
          召: 'Z',
          兆: 'Z',
          照: 'Z',
          罩: 'Z',
          遮: 'Z',
          折: 'Z',
          哲: 'Z',
          者: 'Z',
          这: 'Z',
          浙: 'Z',
          针: 'Z',
          侦: 'Z',
          珍: 'Z',
          真: 'Z',
          诊: 'Z',
          枕: 'Z',
          阵: 'Z',
          振: 'Z',
          镇: 'Z',
          震: 'Z',
          争: 'Z',
          征: 'Z',
          睁: 'Z',
          筝: 'Z',
          蒸: 'Z',
          整: 'Z',
          正: 'Z',
          证: 'Z',
          郑: 'Z',
          政: 'Z',
          症: 'Z',
          之: 'Z',
          支: 'Z',
          只: 'Z',
          芝: 'Z',
          枝: 'Z',
          知: 'Z',
          织: 'Z',
          肢: 'Z',
          脂: 'Z',
          蜘: 'Z',
          执: 'Z',
          直: 'Z',
          值: 'Z',
          职: 'Z',
          植: 'Z',
          殖: 'Z',
          止: 'Z',
          旨: 'Z',
          址: 'Z',
          纸: 'Z',
          指: 'Z',
          至: 'Z',
          志: 'Z',
          制: 'Z',
          帜: 'Z',
          治: 'Z',
          质: 'Z',
          致: 'Z',
          秩: 'Z',
          智: 'Z',
          置: 'Z',
          稚: 'Z',
          中: 'Z',
          忠: 'Z',
          终: 'Z',
          钟: 'Z',
          肿: 'Z',
          种: 'Z',
          仲: 'Z',
          众: 'Z',
          重: 'Z',
          州: 'Z',
          舟: 'Z',
          周: 'Z',
          洲: 'Z',
          粥: 'Z',
          宙: 'Z',
          昼: 'Z',
          皱: 'Z',
          骤: 'Z',
          朱: 'Z',
          株: 'Z',
          珠: 'Z',
          诸: 'Z',
          猪: 'Z',
          竹: 'Z',
          烛: 'Z',
          逐: 'Z',
          主: 'Z',
          煮: 'Z',
          嘱: 'Z',
          住: 'Z',
          助: 'Z',
          注: 'Z',
          驻: 'Z',
          柱: 'Z',
          祝: 'Z',
          著: 'Z',
          筑: 'Z',
          铸: 'Z',
          抓: 'Z',
          爪: 'Z',
          专: 'Z',
          砖: 'Z',
          转: 'Z',
          赚: 'Z',
          庄: 'Z',
          桩: 'Z',
          装: 'Z',
          壮: 'Z',
          状: 'Z',
          撞: 'Z',
          追: 'Z',
          准: 'Z',
          捉: 'Z',
          桌: 'Z',
          卓: 'Z',
          啄: 'Z',
          浊: 'Z',
          资: 'Z',
          姿: 'Z',
          滋: 'Z',
          紫: 'Z',
          仔: 'Z',
          子: 'Z',
          姊: 'Z',
          籽: 'Z',
          字: 'Z',
          自: 'Z',
          宗: 'Z',
          棕: 'Z',
          踪: 'Z',
          总: 'Z',
          纵: 'Z',
          走: 'Z',
          奏: 'Z',
          租: 'Z',
          足: 'Z',
          卒: 'Z',
          族: 'Z',
          阻: 'Z',
          组: 'Z',
          祖: 'Z',
          钻: 'Z',
          嘴: 'Z',
          最: 'Z',
          罪: 'Z',
          醉: 'Z',
          遵: 'Z',
          昨: 'Z',
          左: 'Z',
          佐: 'Z',
          作: 'Z',
          坐: 'Z',
          座: 'Z',
          做: 'Z'
        }

        // 先检查是否在映射表中
        if (pinyinMap[char]) {
          return pinyinMap[char]
        }

        // 如果不在映射表中，使用Unicode范围判断
        // 根据Unicode范围判断拼音首字母
        if (unicode >= 0x4e00 && unicode <= 0x9fa5) {
          // 使用更精确的拼音首字母判断
          // A: 阿埃挨哎唉哀皑癌蔼矮艾碍爱隘
          if (unicode >= 0x554a && unicode <= 0x963f) return 'A'
          // B: 吧笆八疤巴拔跋靶把耙坝霸罢爸白柏百摆佰败拜稗斑班搬扳般颁板版扮拌伴瓣半办绊邦帮梆榜膀绑棒磅蚌镑傍谤苞胞包褒剥
          if (unicode >= 0x5427 && unicode <= 0x8584) return 'B'
          // 如果无法确定，返回X作为默认值
          return 'X'
        }

        // 如果是英文字母，直接返回大写
        if (unicode >= 65 && unicode <= 90) {
          return char
        }
        if (unicode >= 97 && unicode <= 122) {
          return String.fromCharCode(unicode - 32)
        }

        // 其他情况返回空字符串
        return ''
      }

      // 提取前两个字的首字母
      const chars = villageGroup.split('')
      let initials = ''
      for (let i = 0; i < chars.length && initials.length < 2; i++) {
        const initial = getChineseFirstLetter(chars[i])
        if (initial) {
          initials += initial
        }
      }

      groupCode = initials || 'XX'
    } else {
      groupCode = 'XX'
    }

    // 提取身份证后6位
    const idCardSuffix = idCard.substring(idCard.length - 6)

    let baseHouseholdId = `${groupCode}${idCardSuffix}`

    // 2. 检查是否已存在，如果存在则自动加1
    const checkSql = `SELECT household_number FROM households WHERE household_number LIKE ?`

    db.all(checkSql, [`${baseHouseholdId}%`], (err, rows) => {
      if (err) {
        reject(err)
        return
      }

      if (rows.length === 0) {
        // 不存在相同的，直接返回基础ID
        resolve(baseHouseholdId)
        return
      }

      // 存在相同的，找到最大的后缀数字并加1
      let maxSuffix = 0

      rows.forEach((row) => {
        const existingId = row.household_number
        if (existingId === baseHouseholdId) {
          // 完全相同，后缀为0
          maxSuffix = Math.max(maxSuffix, 0)
        } else if (existingId.startsWith(baseHouseholdId)) {
          // 以基础ID开头，提取后缀数字
          const suffix = existingId.substring(baseHouseholdId.length)
          const suffixNum = parseInt(suffix)
          if (!isNaN(suffixNum)) {
            maxSuffix = Math.max(maxSuffix, suffixNum)
          }
        }
      })

      // 生成新的户主ID
      const newHouseholdId =
        maxSuffix === 0 ? `${baseHouseholdId}1` : `${baseHouseholdId}${maxSuffix + 1}`
      resolve(newHouseholdId)
    })
  })
}

// 居民信息API - 从真实数据库获取数据
router.get('/residents', checkPermission('resident:view'), (req, res) => {
  console.log('收到/residents请求，查询参数:', req.query)

  // 构建SQL查询 - 关联households表获取家庭地址和户主信息
  let sql = `SELECT 
              r.id, 
              r.name, 
              r.id_card AS idCard, 
              r.gender,
              r.ethnicity,
              r.date_of_birth AS dateOfBirth, 
              YEAR(CURDATE()) - YEAR(r.date_of_birth) AS age, 
              r.village_group AS villageGroup, 
              h.address, 
              r.bank_card AS bankCard, 
              r.phone_number AS phoneNumber, 
              r.household_id,
              h.household_head_name,
              r.relationship_to_head,
              h.household_number,
              r.status,
              r.equity_shares,
              r.occupation
            FROM residents r
            LEFT JOIN households h ON r.household_id = h.household_number
            WHERE h.status = 'active'`

  // 接收所有查询参数
  console.log('收到/residents请求，查询参数:', req.query)

  // 添加查询条件
  const params = []

  // 添加居民状态筛选
  if (req.query.status) {
    sql += ` AND r.status = ?`
    params.push(req.query.status)
  } else {
    // status 为空时查询所有状态的居民
  }

  // 支持keyword参数，同时搜索姓名和身份证号（优先级最高）
  if (req.query.keyword && req.query.keyword.trim() !== '') {
    console.log('执行关键字搜索:', req.query.keyword)
    sql += ` AND (r.name LIKE ? OR r.id_card LIKE ?)`
    params.push(`%${req.query.keyword.trim()}%`, `%${req.query.keyword.trim()}%`)
  } else {
    // 如果没有keyword，才检查其他单独的参数
    if (req.query.name) {
      sql += ` AND r.name LIKE ?`
      params.push(`%${req.query.name}%`)
    }
    if (req.query.idCard) {
      sql += ` AND r.id_card LIKE ?`
      params.push(`%${req.query.idCard}%`)
    }
  }

  if (req.query.gender) {
    sql += ` AND r.gender = ?`
    params.push(req.query.gender)
  }
  if (req.query.villageGroup && req.query.villageGroup.trim() !== '') {
    sql += ` AND r.village_group = ?`
    params.push(req.query.villageGroup)
  }
  if (req.query.birthYear) {
    sql += ` AND YEAR(r.date_of_birth) = ?`
    params.push(req.query.birthYear)
  }
  if (req.query.phoneNumber) {
    sql += ` AND r.phone_number LIKE ?`
    params.push(`%${req.query.phoneNumber}%`)
  }
  if (req.query.household_id) {
    sql += ` AND r.household_id = ?`
    params.push(req.query.household_id)
  }
  if (req.query.isHouseholdHead !== undefined) {
    if (req.query.isHouseholdHead === 'true' || req.query.isHouseholdHead === true) {
      sql += ` AND (r.relationship_to_head = '本人' OR r.relationship_to_head = '户主')`
    } else if (req.query.isHouseholdHead === 'false' || req.query.isHouseholdHead === false) {
      sql += ` AND r.relationship_to_head != '本人' AND r.relationship_to_head != '户主'`
    }
  }

  // 特殊处理户主姓名查询（支持 householdHeadName 和 householderName 两种参数名）
  const householdHeadName = req.query.householdHeadName || req.query.householderName
  if (householdHeadName) {
    // 先查询对应家庭的household_number
    const householdsSql = `SELECT household_number FROM households WHERE household_head_name LIKE ? AND status = 'active'`
    db.all(householdsSql, [`%${householdHeadName}%`], (householdErr, households) => {
      if (householdErr) {
        console.error('查询家庭失败:', householdErr.message)
        res.status(500).json({ code: 500, message: '查询居民数据失败' })
        return
      }

      if (households.length > 0) {
        // 有匹配的家庭，查询这些家庭的所有居民
        const householdNumbers = households.map((h) => h.household_number)
        const numbersPlaceholders = householdNumbers.map(() => '?').join(',')
        const finalSql = `${sql} AND r.household_id IN (${numbersPlaceholders})`
        const finalParams = [...params, ...householdNumbers]

        // 执行完整查询获取所有数据
        db.all(finalSql, finalParams, (allErr, allResidents) => {
          if (allErr) {
            console.error('查询所有居民数据失败:', allErr.message)
            res.status(500).json({ code: 500, message: '查询居民数据失败' })
            return
          }

          // 计算总人数和总户数
          const totalPersons = allResidents.length
          const uniqueHouseholdIds = new Set(
            allResidents.map((resident) => resident.household_id).filter(Boolean)
          )
          const totalHouseholds = uniqueHouseholdIds.size

          // 获取分页数据
          const pageNum = parseInt(req.query.pageNum) || 1
          const pageSize = parseInt(req.query.pageSize) || 10
          const offset = (pageNum - 1) * pageSize
          const pageResidents = allResidents.slice(offset, offset + pageSize)

          // 返回结果
          res.json({
            code: 20000,
            data: pageResidents,
            total: totalPersons,
            totalHouseholds: totalHouseholds,
            totalPersons: totalPersons
          })
        })
      } else {
        // 没有匹配的家庭，返回空结果
        res.json({
          code: 20000,
          data: [],
          total: 0,
          totalHouseholds: 0,
          totalPersons: 0
        })
      }
    })
    return
  }

  // 执行完整查询获取所有数据
  db.all(sql, params, (allErr, allResidents) => {
    if (allErr) {
      console.error('查询所有居民数据失败:', allErr.message)
      res.status(500).json({ code: 500, message: '查询居民数据失败' })
      return
    }

    // 计算总人数和总户数
    const totalPersons = allResidents.length
    const uniqueHouseholdIds = new Set(
      allResidents.map((resident) => resident.household_id).filter(Boolean)
    )
    const totalHouseholds = uniqueHouseholdIds.size

    // 获取分页数据
    const pageNum = parseInt(req.query.pageNum) || 1
    const pageSize = parseInt(req.query.pageSize) || 10
    const offset = (pageNum - 1) * pageSize
    const pageResidents = allResidents.slice(offset, offset + pageSize)

    // 返回结果
    res.json({
      code: 20000,
      data: pageResidents,
      total: totalPersons,
      totalHouseholds: totalHouseholds,
      totalPersons: totalPersons
    })
  })
})

// 独立成户 API - 必须放在 /residents/:id 之前，避免被拦截
router.post('/residents/:id/split-household', checkPermission('resident:edit'), async (req, res) => {
  const { id } = req.params
  const { keepAddress = true, keepVillageGroup = true } = req.body

  console.log('收到独立成户请求:', { residentId: id, keepAddress, keepVillageGroup })

  try {
    // 开启事务
    await new Promise((resolve, reject) => {
      db.run('BEGIN TRANSACTION', (err) => {
        if (err) reject(err)
        else resolve()
      })
    })

    // 1. 查询当前居民信息
    const resident = await new Promise((resolve, reject) => {
      db.get(
        `SELECT r.*, h.address as household_address, h.village_group as household_village_group
         FROM residents r
         LEFT JOIN households h ON r.household_id = h.household_number
         WHERE r.id = ? AND r.status = 'active'`,
        [id],
        (err, row) => {
          if (err) reject(err)
          else resolve(row)
        }
      )
    })

    if (!resident) {
      await new Promise((resolve) => db.run('ROLLBACK', resolve))
      return res.status(404).json({ code: 404, message: '未找到居民信息' })
    }

    // 检查是否是户主
    if (resident.relationship_to_head === '本人' || resident.relationship_to_head === '户主') {
      await new Promise((resolve) => db.run('ROLLBACK', resolve))
      return res.status(400).json({ code: 400, message: '户主不能独立成户，请先更换户主' })
    }

    const oldHouseholdId = resident.household_id

    // 2. 生成新的户编号
    const villageGroup = keepVillageGroup
      ? resident.household_village_group || resident.village_group
      : resident.village_group
    const idCardSuffix = resident.id_card ? resident.id_card.slice(-6) : '000000'

    // 获取村组首字母
    let groupCode = 'XX'
    if (villageGroup) {
      const pinyinMap = {
        一: 'Y',
        二: 'E',
        三: 'S',
        四: 'S',
        五: 'W',
        六: 'L',
        七: 'Q',
        八: 'B',
        九: 'J',
        十: 'S',
        大: 'D',
        小: 'X',
        前: 'Q',
        后: 'H',
        东: 'D',
        西: 'X',
        南: 'N',
        北: 'B',
        中: 'Z',
        山: 'S',
        河: 'H',
        村: 'C',
        庄: 'Z',
        镇: 'Z',
        乡: 'X'
      }
      const firstChar = villageGroup.charAt(0)
      const secondChar = villageGroup.charAt(1)
      groupCode = (pinyinMap[firstChar] || firstChar) + (pinyinMap[secondChar] || secondChar)
    }

    let newHouseholdNumber = `${groupCode}${idCardSuffix}`

    // 检查户编号是否已存在，如果存在则添加后缀
    const checkHouseholdNumber = async (number, suffix = 0) => {
      const checkNumber = suffix === 0 ? number : `${number}-${suffix}`
      const exists = await new Promise((resolve, reject) => {
        db.get('SELECT 1 FROM households WHERE household_number = ?', [checkNumber], (err, row) => {
          if (err) reject(err)
          else resolve(!!row)
        })
      })
      if (exists) {
        return checkHouseholdNumber(number, suffix + 1)
      }
      return checkNumber
    }

    newHouseholdNumber = await checkHouseholdNumber(newHouseholdNumber)

    // 3. 创建新的 households 记录
    const address = keepAddress
      ? resident.household_address || resident.Home_address
      : resident.Home_address
    const registeredDate = new Date().toISOString().split('T')[0] // 当前日期

    await new Promise((resolve, reject) => {
      db.run(
        `INSERT INTO households (
          household_number, household_head_name, household_head_id_card,
          village_group, address, gender, ethnicity,
          household_type, housing_type, status, registered_date
        ) VALUES (?, ?, ?, ?, ?, ?, ?, '农村居民户口', '自有住房', 'active', ?)`,
        [
          newHouseholdNumber,
          resident.name,
          resident.id_card,
          villageGroup,
          address,
          resident.gender,
          resident.ethnicity,
          registeredDate
        ],
        (err) => {
          if (err) reject(err)
          else resolve()
        }
      )
    })

    // 4. 更新居民信息
    await new Promise((resolve, reject) => {
      db.run(
        `UPDATE residents SET
          household_id = ?,
          household_head_id = ?,
          relationship_to_head = '本人',
          Home_address = ?,
          village_group = ?
         WHERE id = ?`,
        [newHouseholdNumber, id, address, villageGroup, id],
        (err) => {
          if (err) reject(err)
          else resolve()
        }
      )
    })

    // 提交事务
    await new Promise((resolve, reject) => {
      db.run('COMMIT', (err) => {
        if (err) reject(err)
        else resolve()
      })
    })

    console.log('独立成户成功:', { residentId: id, newHouseholdNumber })

    res.json({
      code: 20000,
      success: true,
      message: '独立成户成功',
      data: {
        newHouseholdNumber,
        residentName: resident.name
      }
    })
  } catch (error) {
    console.error('独立成户失败:', error)
    await new Promise((resolve) => db.run('ROLLBACK', resolve))
    res.status(500).json({ code: 500, message: '独立成户失败: ' + error.message })
  }
})

// 跨户迁移 API - 将居民迁移到另一个家庭
router.post('/residents/:id/migrate-household', checkPermission('resident:edit'), async (req, res) => {
  const { id } = req.params
  const { targetHouseholdNumber, targetHouseholdHeadId, relationshipToHead } = req.body

  console.log('收到跨户迁移请求:', {
    residentId: id,
    targetHouseholdNumber,
    targetHouseholdHeadId,
    relationshipToHead
  })

  if (!targetHouseholdNumber || !targetHouseholdHeadId || !relationshipToHead) {
    return res.status(400).json({
      code: 400,
      message: '缺少必要参数：目标家庭编号、目标户主ID或与户主关系'
    })
  }

  try {
    // 开启事务
    await new Promise((resolve, reject) => {
      db.run('BEGIN TRANSACTION', (err) => {
        if (err) reject(err)
        else resolve()
      })
    })

    // 1. 查询当前居民信息
    const resident = await new Promise((resolve, reject) => {
      db.get(
        `SELECT r.*, h.address as household_address, h.village_group as household_village_group
         FROM residents r
         LEFT JOIN households h ON r.household_id = h.household_number
         WHERE r.id = ? AND r.status = 'active'`,
        [id],
        (err, row) => {
          if (err) reject(err)
          else resolve(row)
        }
      )
    })

    if (!resident) {
      await new Promise((resolve) => db.run('ROLLBACK', resolve))
      return res.status(404).json({ code: 404, message: '未找到居民信息' })
    }

    // 检查是否是户主
    if (resident.relationship_to_head === '本人' || resident.relationship_to_head === '户主') {
      await new Promise((resolve) => db.run('ROLLBACK', resolve))
      return res.status(400).json({ code: 400, message: '户主不能跨户迁移，请先更换户主' })
    }

    // 2. 查询目标家庭信息
    const targetHousehold = await new Promise((resolve, reject) => {
      db.get(
        `SELECT * FROM households WHERE household_number = ? AND status = 'active'`,
        [targetHouseholdNumber],
        (err, row) => {
          if (err) reject(err)
          else resolve(row)
        }
      )
    })

    if (!targetHousehold) {
      await new Promise((resolve) => db.run('ROLLBACK', resolve))
      return res.status(404).json({ code: 404, message: '目标家庭不存在' })
    }

    // 3. 更新居民信息 - 迁移到目标家庭
    await new Promise((resolve, reject) => {
      db.run(
        `UPDATE residents SET
          household_id = ?,
          household_head_id = ?,
          relationship_to_head = ?,
          Home_address = ?,
          village_group = ?
         WHERE id = ?`,
        [
          targetHouseholdNumber,
          targetHouseholdHeadId,
          relationshipToHead,
          targetHousehold.address || resident.Home_address,
          targetHousehold.village_group || resident.village_group,
          id
        ],
        (err) => {
          if (err) reject(err)
          else resolve()
        }
      )
    })

    // 4. 记录迁移日志（可选）
    await new Promise((resolve, reject) => {
      db.run(
        `INSERT INTO household_change_log (
          resident_id, change_type, change_date, change_reason, 
          previous_status, new_status, operator
        ) VALUES (?, ?, ?, ?, ?, ?, ?)`,
        [
          id,
          'migration_in',
          new Date().toISOString().split('T')[0],
          `从家庭 ${resident.household_id} 迁移到家庭 ${targetHouseholdNumber}`,
          resident.household_id,
          targetHouseholdNumber,
          'system'
        ],
        (err) => {
          if (err) {
            console.error('记录迁移日志失败:', err.message)
            // 日志记录失败不影响主流程
          }
          resolve()
        }
      )
    })

    // 提交事务
    await new Promise((resolve, reject) => {
      db.run('COMMIT', (err) => {
        if (err) reject(err)
        else resolve()
      })
    })

    console.log('跨户迁移成功:', {
      residentId: id,
      residentName: resident.name,
      fromHousehold: resident.household_id,
      toHousehold: targetHouseholdNumber
    })

    res.json({
      code: 20000,
      success: true,
      message: '跨户迁移成功',
      data: {
        residentId: id,
        residentName: resident.name,
        targetHouseholdNumber,
        relationshipToHead
      }
    })
  } catch (error) {
    console.error('跨户迁移失败:', error)
    await new Promise((resolve) => db.run('ROLLBACK', resolve))
    res.status(500).json({ code: 500, message: '跨户迁移失败: ' + error.message })
  }
})

// 获取单个居民详情
router.get('/residents/:id', checkPermission('resident:view'), (req, res) => {
  const { id } = req.params

  const sql = `SELECT
                r.id,
                r.name,
                r.id_card AS idCard,
                r.gender,
                r.date_of_birth AS dateOfBirth,
                YEAR(CURDATE()) - YEAR(r.date_of_birth) AS age,
                r.village_group AS villageGroup,
                r.Home_address AS homeAddress,
                r.bank_card AS bankCard,
                r.bank_name AS bankName,
                r.phone_number AS phoneNumber,
                r.household_id AS householdId,
                r.status,
                r.relationship_to_head AS relationshipToHead,
                r.ethnicity,
                r.marital_status AS maritalStatus,
                r.political_status AS politicalStatus,
                r.military_service AS militaryService,
                r.education_level AS educationLevel,
                r.equity_shares,
                r.household_registration_status AS householdRegistrationStatus,
                r.migration_in_date AS migrationInDate,
                r.migration_out_date AS migrationOutDate,
                r.death_date AS deathDate,
                r.account_cancellation_date AS accountCancellationDate
              FROM residents r
              WHERE r.id = ?`

  db.get(sql, [id], (err, resident) => {
    if (err) {
      console.error('查询居民详情失败:', err.message)
      res.status(500).json({ code: 500, message: '查询居民详情失败' })
      return
    }

    // 查询最新的户籍变动记录，获取完整的变动信息
    const changeLogSql = `SELECT 
                           migration_in_date, migration_in_reason, 
                           migration_out_date, migration_out_reason, 
                           death_date, death_reason
                         FROM household_change_log 
                         WHERE resident_id = ? 
                         ORDER BY created_at DESC 
                         LIMIT 1`

    db.get(changeLogSql, [id], (logErr, latestLog) => {
      if (logErr) {
        console.error('查询户籍变动记录失败:', logErr.message)
        // 即使查询失败，也返回基本的居民信息
        res.json({ code: 20000, data: { ...resident } })
        return
      }

      // 合并居民信息和最新的变动记录
      const fullResidentData = { ...resident, ...latestLog }
      res.json({ code: 20000, data: fullResidentData })
    })
  })
})

// 创建户主
router.post('/households', checkPermission('resident:add'), async (req, res) => {
  const {
    household_number,
    village_group,
    household_head_name,
    household_head_id_card,
    ethnicity,
    household_type,
    housing_type,
    address,
    phone_number,
    gender
  } = req.body

  // 验证身份证号是否已存在
  if (household_head_id_card) {
    try {
      const [existingHouseholds] = await db.pool.execute(
        'SELECT id, household_head_name FROM households WHERE household_head_id_card = ? AND status = "active"',
        [household_head_id_card]
      )
      if (existingHouseholds.length > 0) {
        return res.status(400).json({
          code: 400,
          message: `身份证号 ${household_head_id_card} 已存在，户主为 ${existingHouseholds[0].household_head_name}，不能重复创建户主`
        })
      }
    } catch (checkErr) {
      console.error('检查身份证号失败:', checkErr.message)
    }
  }

  // 设置默认值，确保所有必填字段都有值
  const status = 'active'
  const registered_date = new Date().toISOString().split('T')[0] // 默认是当前日期
  const defaultEthnicity = ethnicity || '汉族' // 为ethnicity设置默认值
  const defaultHouseholdType = household_type || '' // 为household_type设置默认值
  const defaultHousingType = housing_type || '' // 为housing_type设置默认值
  const defaultAddress = address || '' // 为address设置默认值
  const defaultGender = gender || '' // 为gender设置默认值

  try {
    // 优先使用前端传入的户编号，如果没有则自动生成
    let finalHouseholdNumber = household_number
    if (!finalHouseholdNumber) {
      finalHouseholdNumber = await generateHouseholdId(village_group, household_head_id_card)
    }

    // 使用 MariaDB 的 pool 直接执行，避免 db.run 的语法转换问题
    const sql = `INSERT INTO households 
                 (household_number, village_group, household_head_name, household_head_id_card, ethnicity, household_type, housing_type, address, phone_number, gender, status, registered_date) 
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`

    const params = [
      finalHouseholdNumber,
      village_group,
      household_head_name,
      household_head_id_card,
      defaultEthnicity,
      defaultHouseholdType,
      defaultHousingType,
      defaultAddress,
      phone_number,
      defaultGender,
      status,
      registered_date
    ]

    // 使用 pool.execute 直接执行，获取 insertId
    db.pool
      .execute(sql, params)
      .then(([result]) => {
        res.json({
          code: 20000,
          message: '创建户主成功',
          data: { id: result.insertId, householdNumber: finalHouseholdNumber }
        })
      })
      .catch((err) => {
        console.error('创建户主失败:', err.message)
        res.status(500).json({ code: 500, message: '创建户主失败: ' + err.message })
      })
  } catch (error) {
    console.error('生成户主ID失败:', error.message)
    res.status(500).json({ code: 500, message: '生成户主ID失败: ' + error.message })
  }
})

// 根据户主姓名查询户主信息
router.get('/households', checkPermission('resident:view'), (req, res) => {
  const { household_head_name } = req.query

  if (!household_head_name) {
    return res.status(400).json({ code: 400, message: '缺少户主姓名参数' })
  }

  const sql = `SELECT * FROM households WHERE household_head_name LIKE ? AND status = 'active'`
  const params = [`%${household_head_name}%`]

  db.all(sql, params, (err, rows) => {
    if (err) {
      console.error('查询户主信息失败:', err.message)
      return res.status(500).json({ code: 500, message: '查询户主信息失败' })
    }

    res.json({ code: 20000, data: rows })
  })
})

// 更换户主 API - 必须放在 /households/:id 之前，避免被拦截
router.post('/households/:id/change-head', checkPermission('resident:edit'), async (req, res) => {
  const { id } = req.params
  const { newHeadResidentId, oldHeadNewRelationship } = req.body

  console.log('收到更换户主请求:', { householdId: id, newHeadResidentId, oldHeadNewRelationship })

  if (!newHeadResidentId || !oldHeadNewRelationship) {
    return res.status(400).json({ code: 400, message: '缺少必要参数' })
  }

  try {
    // 开启事务
    await new Promise((resolve, reject) => {
      db.run('BEGIN TRANSACTION', (err) => {
        if (err) reject(err)
        else resolve()
      })
    })

    // 1. 查询当前户主信息
    const currentHead = await new Promise((resolve, reject) => {
      db.get(
        `SELECT id, name, id_card, household_id FROM residents 
         WHERE household_id = ? AND (relationship_to_head = '本人' OR relationship_to_head = '户主') AND status = 'active'`,
        [id],
        (err, row) => {
          if (err) reject(err)
          else resolve(row)
        }
      )
    })

    if (!currentHead) {
      await new Promise((resolve) => db.run('ROLLBACK', resolve))
      return res.status(404).json({ code: 404, message: '未找到当前户主' })
    }

    // 2. 查询新户主信息（获取 residents 表中的完整信息）
    const newHead = await new Promise((resolve, reject) => {
      db.get(
        `SELECT id, name, id_card, gender, ethnicity, village_group, Home_address, phone_number 
         FROM residents 
         WHERE id = ? AND household_id = ? AND status = 'active'`,
        [newHeadResidentId, id],
        (err, row) => {
          if (err) reject(err)
          else resolve(row)
        }
      )
    })

    if (!newHead) {
      await new Promise((resolve) => db.run('ROLLBACK', resolve))
      return res.status(404).json({ code: 404, message: '未找到新户主成员' })
    }

    // 3. 更新原户主的 relationship_to_head
    await new Promise((resolve, reject) => {
      db.run(
        `UPDATE residents SET relationship_to_head = ? WHERE id = ?`,
        [oldHeadNewRelationship, currentHead.id],
        (err) => {
          if (err) reject(err)
          else resolve()
        }
      )
    })

    // 4. 更新新户主的 relationship_to_head 为“本人”
    await new Promise((resolve, reject) => {
      db.run(
        `UPDATE residents SET relationship_to_head = '本人' WHERE id = ?`,
        [newHead.id],
        (err) => {
          if (err) reject(err)
          else resolve()
        }
      )
    })

    // 5. 更新 households 表的户主信息（使用新户主在 residents 表中的完整信息）
    await new Promise((resolve, reject) => {
      db.run(
        `UPDATE households SET 
          household_head_name = ?,
          household_head_id_card = ?,
          gender = ?,
          ethnicity = ?,
          village_group = ?,
          address = ?,
          phone_number = ?
         WHERE household_number = ?`,
        [
          newHead.name,
          newHead.id_card,
          newHead.gender,
          newHead.ethnicity,
          newHead.village_group || '',
          newHead.Home_address || '',
          newHead.phone_number || '',
          id
        ],
        (err) => {
          if (err) reject(err)
          else resolve()
        }
      )
    })

    // 6. 更新所有成员的 household_head_id
    await new Promise((resolve, reject) => {
      db.run(
        `UPDATE residents SET household_head_id = ? WHERE household_id = ?`,
        [newHead.id, id],
        (err) => {
          if (err) reject(err)
          else resolve()
        }
      )
    })

    // 提交事务
    await new Promise((resolve, reject) => {
      db.run('COMMIT', (err) => {
        if (err) reject(err)
        else resolve()
      })
    })

    console.log('更换户主成功:', { oldHead: currentHead.name, newHead: newHead.name })

    res.json({
      code: 20000,
      success: true,
      message: '更换户主成功',
      data: {
        oldHead: { id: currentHead.id, name: currentHead.name },
        newHead: { id: newHead.id, name: newHead.name }
      }
    })
  } catch (error) {
    console.error('更换户主失败:', error)
    await new Promise((resolve) => db.run('ROLLBACK', resolve))
    res.status(500).json({ code: 500, message: '更换户主失败: ' + error.message })
  }
})

// 更新户主信息
router.put('/households/:id', checkPermission('resident:edit'), (req, res) => {
  const { id } = req.params

  // 添加成功更新的日志，便于调试
  console.log('收到更新户主信息请求，ID:', id)
  console.log('更新数据:', req.body)

  // 只更新传递的字段
  const updateFields = []
  const params = []

  // 同时处理驼峰命名和下划线命名的字段
  if (req.body.household_number !== undefined) {
    updateFields.push('household_number = ?')
    params.push(req.body.household_number)
  }
  if (req.body.village_group !== undefined) {
    updateFields.push('village_group = ?')
    params.push(req.body.village_group)
  }
  if (req.body.household_head_name !== undefined) {
    updateFields.push('household_head_name = ?')
    params.push(req.body.household_head_name)
  }
  if (req.body.household_head_id_card !== undefined) {
    updateFields.push('household_head_id_card = ?')
    params.push(req.body.household_head_id_card)
  }
  if (req.body.ethnicity !== undefined) {
    updateFields.push('ethnicity = ?')
    params.push(req.body.ethnicity)
  }
  if (req.body.household_type !== undefined) {
    updateFields.push('household_type = ?')
    params.push(req.body.household_type)
  }
  if (req.body.housing_type !== undefined) {
    updateFields.push('housing_type = ?')
    params.push(req.body.housing_type)
  }
  if (req.body.address !== undefined) {
    updateFields.push('address = ?')
    params.push(req.body.address)
  }
  if (req.body.phone_number !== undefined) {
    updateFields.push('phone_number = ?')
    params.push(req.body.phone_number)
  }
  if (req.body.gender !== undefined) {
    updateFields.push('gender = ?')
    params.push(req.body.gender)
  }
  if (req.body.household_head_id !== undefined) {
    updateFields.push('household_head_id = ?')
    params.push(req.body.household_head_id)
  }

  // 如果没有要更新的字段，直接返回成功
  if (updateFields.length === 0) {
    console.log('没有要更新的字段，直接返回成功')
    return res.json({ code: 20000, message: '更新户主信息成功' })
  }

  // 构建SQL语句 - 支持通过id或household_number更新
  let sql
  // 判断id是否为数字（自增ID）还是字符串（户编号）
  if (/^\d+$/.test(id)) {
    // 数字ID，使用id字段查询
    sql = `UPDATE households SET ${updateFields.join(', ')} WHERE id = ?`
  } else {
    // 非数字，认为是户编号，使用household_number字段查询
    sql = `UPDATE households SET ${updateFields.join(', ')} WHERE household_number = ?`
  }
  params.push(id)

  console.log('执行SQL:', sql)
  console.log('SQL参数:', params)

  db.run(sql, params, function (err) {
    if (err) {
      console.error('更新户主信息失败:', err.message)
      return res.status(500).json({ code: 500, message: '更新户主信息失败: ' + err.message })
    }
    // 添加成功更新的日志，便于调试
    console.log('更新户主信息成功，ID:', id)
    res.json({ code: 20000, message: '更新户主信息成功' })
  })
})

// 获取单个户主详情
router.get('/households/:id', checkPermission('resident:view'), (req, res) => {
  const { id } = req.params

  // 支持通过id或household_number查询
  const sql = `SELECT * FROM households WHERE id = ? OR household_number = ?`

  db.get(sql, [id, id], (err, household) => {
    if (err) {
      console.error('查询户主详情失败:', err.message)
      res.status(500).json({ code: 500, message: '查询户主详情失败' })
      return
    }

    res.json({ code: 20000, data: household })
  })
})

// 检查户编号是否已存在
router.get('/households/check-household-number', checkPermission('resident:view'), (req, res) => {
  const { household_number } = req.query

  if (!household_number) {
    return res.status(400).json({ code: 400, message: '缺少户编号参数' })
  }

  const sql = `SELECT COUNT(*) as count FROM households WHERE household_number = ?`

  db.get(sql, [household_number], (err, result) => {
    if (err) {
      console.error('检查户编号失败:', err.message)
      res.status(500).json({ code: 500, message: '检查户编号失败' })
      return
    }

    const exists = result.count > 0
    res.json({ code: 20000, exists })
  })
})

router.get('/households/:id/members', checkPermission('resident:view'), (req, res) => {
  const { id } = req.params

  // 构建SQL查询，获取该户主下的所有成员，包括非active状态
  const sql = `SELECT 
                r.id, 
                r.name, 
                r.id_card, 
                r.gender, 
                r.date_of_birth, 
                YEAR(CURDATE()) - YEAR(r.date_of_birth) AS age, 
                r.village_group, 
                r.bank_card, 
                r.bank_name, 
                r.phone_number, 
                r.household_id, 
                r.status, 
                r.relationship_to_head, 
                r.ethnicity, 
                r.marital_status, 
                r.political_status, 
                r.military_service, 
                r.education_level 
              FROM residents r 
              WHERE r.household_id = ?`

  db.all(sql, [id], (err, members) => {
    if (err) {
      console.error('查询家庭成员失败:', err.message)
      res.status(500).json({ code: 500, message: '查询家庭成员失败' })
      return
    }

    res.json({ code: 20000, data: members })
  })
})

// 更新居民状态
router.put('/residents/:id/status', checkPermission('resident:edit'), async (req, res) => {
  const { id } = req.params
  const {
    status,
    death_date,
    death_reason,
    migration_in_date,
    migration_in_reason,
    migration_out_date,
    migration_out_reason
  } = req.body

  // 验证status值
  const validStatuses = ['active', 'migrated_out', 'deceased']
  if (!validStatuses.includes(status)) {
    return res.status(400).json({ code: 400, message: '无效的状态值' })
  }

  let connection
  try {
    // 获取数据库连接
    connection = await db.pool.getConnection()

    // 开始事务
    await connection.beginTransaction()

    // 首先获取居民的当前状态
    const [rows] = await connection.execute('SELECT status FROM residents WHERE id = ?', [id])
    const previousStatus = rows.length > 0 ? rows[0].status : null
    const currentTime = new Date().toISOString().slice(0, 19).replace('T', ' ')

    // 更新residents表中的status字段
    await connection.execute('UPDATE residents SET status = ? WHERE id = ?', [status, id])

    // 确定变更类型
    let changeType = ''
    let changeDate = currentTime
    let changeReason = ''

    if (migration_in_date) {
      changeType = '迁入'
      changeDate = migration_in_date
      changeReason = migration_in_reason || ''
    } else if (migration_out_date) {
      changeType = '迁出'
      changeDate = migration_out_date
      changeReason = migration_out_reason || ''
    } else if (death_date) {
      changeType = '死亡注销'
      changeDate = death_date
      changeReason = death_reason || ''
    } else if (status === 'active' && previousStatus === 'active') {
      changeType = '状态恢复'
      changeDate = currentTime
    } else {
      changeType = '状态变更'
      changeDate = currentTime
    }

    // 向户籍变动记录表中插入一条记录
    const logSql = `INSERT INTO household_change_log
                   (resident_id, change_type, change_date, change_reason, previous_status, new_status, 
                    migration_in_date, migration_in_reason, migration_out_date, migration_out_reason, 
                    death_date, death_reason, created_at)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())`

    const logParams = [
      id,
      changeType,
      changeDate,
      changeReason,
      previousStatus,
      status,
      migration_in_date || null,
      migration_in_reason || null,
      migration_out_date || null,
      migration_out_reason || null,
      death_date || null,
      death_reason || null
    ]

    await connection.execute(logSql, logParams)

    // 联动更新低收入人员状态
    if (status === 'deceased' || status === 'migrated_out') {
      // 将对应的低收入人员状态设置为 inactive
      await connection.execute(
        'UPDATE low_income_persons SET status = ?, updated_at = NOW() WHERE resident_id = ? AND status = ?',
        ['inactive', id, 'active']
      )
      console.log(`已更新居民 ${id} 的低收入人员状态为 inactive`)

      // 将对应的残疾人状态设置为 注销
      await connection.execute(
        'UPDATE disabled_persons SET certificate_status = ?, updated_at = NOW() WHERE resident_id = ? AND certificate_status = ?',
        ['注销', id, '在持']
      )
      console.log(`已更新居民 ${id} 的残疾人状态为 注销`)
    } else if (
      status === 'active' &&
      (previousStatus === 'deceased' || previousStatus === 'migrated_out')
    ) {
      // 如果居民从死亡/迁出状态恢复为在住，可以选择恢复低收入和残疾人状态
      // 这里根据业务需求决定是否恢复，暂时不自动恢复
      console.log(`居民 ${id} 状态恢复为 active，但不自动恢复低收入和残疾人状态`)
    }

    // 提交事务
    await connection.commit()

    res.json({ code: 20000, message: '状态更新成功' })
  } catch (err) {
    console.error('更新居民状态失败:', err.message)
    if (connection) {
      await connection.rollback()
    }
    res.status(500).json({ code: 500, message: '更新居民状态失败: ' + err.message })
  } finally {
    if (connection) {
      connection.release()
    }
  }
})

// 更新居民信息
router.put('/residents/:id', checkPermission('resident:edit'), (req, res) => {
  const { id } = req.params
  // 同时处理驼峰命名和下划线命名的字段
  const name = req.body.name
  const id_card = req.body.idCard || req.body.id_card
  const gender = req.body.gender
  const date_of_birth = req.body.dateOfBirth || req.body.date_of_birth
  const village_group = req.body.villageGroup || req.body.village_group
  // 处理Home_address字段
  const home_address = req.body.Home_address || req.body.address
  const bank_card = req.body.bankCard || req.body.bank_card
  const phone_number = req.body.phoneNumber || req.body.phone_number
  const bank_name = req.body.bankName || req.body.bank_name
  const ethnicity = req.body.ethnicity
  const relationship_to_head = req.body.relationship_to_head
  const marital_status = req.body.marital_status
  const political_status = req.body.political_status
  const military_service = req.body.military_service
  const education_level = req.body.education_level

  // 添加成功更新的日志，便于调试
  console.log('收到更新居民信息请求，ID:', id)
  console.log('更新数据:', req.body)

  // 检查必要字段是否存在
  if (!name || !id_card) {
    console.error('更新居民信息失败: 缺少必要字段')
    return res.status(400).json({ code: 400, message: '更新居民信息失败: 缺少必要字段' })
  }

  // 添加equity_shares字段的处理
  const equity_shares = req.body.equity_shares || req.body.equityShares || 0

  const sql = `UPDATE residents 
               SET name = ?, 
                   id_card = ?, 
                   gender = ?, 
                   date_of_birth = ?, 
                   village_group = ?, 
                   Home_address = ?, 
                   bank_card = ?, 
                   phone_number = ?, 
                   bank_name = ?, 
                   ethnicity = ?, 
                   relationship_to_head = ?, 
                   marital_status = ?, 
                   political_status = ?, 
                   military_service = ?, 
                   education_level = ?, 
                   equity_shares = ? 
               WHERE id = ?`

  const params = [
    name,
    id_card,
    gender,
    date_of_birth,
    village_group,
    home_address,
    bank_card,
    phone_number,
    bank_name,
    ethnicity,
    relationship_to_head,
    marital_status,
    political_status,
    military_service,
    education_level,
    equity_shares,
    id
  ]

  db.run(sql, params, function (err) {
    if (err) {
      console.error('更新居民信息失败:', err.message)
      return res.status(500).json({ code: 500, message: '更新居民信息失败: ' + err.message })
    }
    // 添加成功更新的日志，便于调试
    console.log('更新居民信息成功，ID:', id)
    res.json({ code: 20000, message: '更新居民信息成功' })
  })
})

// 新增居民
router.post('/residents', checkPermission('resident:add'), async (req, res) => {
  console.log('========== 收到新增居民请求 ==========')
  console.log('原始数据:', JSON.stringify(req.body, null, 2))

  try {
    // 接收前端传递的数据，处理字段名不匹配的问题（支持驼峰和下划线两种命名）
    const name = req.body.name
    const idCard = req.body.idCard || req.body.id_card
    const gender = req.body.gender
    const dateOfBirth = req.body.dateOfBirth || req.body.date_of_birth
    const villageGroup = req.body.villageGroup || req.body.village_group || '未知'
    const homeAddress = req.body.address || req.body.Home_address || ''
    const bankCard = req.body.bankCard || req.body.bank_card || null
    const phoneNumber = req.body.phoneNumber || req.body.phone_number || null
    const bankName = req.body.bankName || req.body.bank_name || null
    // 支持驼峰命名 householdId 和下划线命名 household_id
    const household_id = req.body.householdId || req.body.household_id

    // 检查 household_id 是否为空
    if (!household_id) {
      console.error('错误: household_id 为空')
      return res.status(400).json({ code: 400, message: '户ID不能为空' })
    }

    // household_head_id 应该是整数类型，但前端传的是字符串 household_id
    // 暂时设为 null，后续可以从 households 表查询对应的户主 resident_id
    const household_head_id = req.body.householdHeadId || req.body.household_head_id || null
    const status = req.body.status || 'active'

    // 支持与户主关系字段（驼峰和下划线）
    const relationship_to_head =
      req.body.relationshipToHead || req.body.relationship_to_head || '其他'
    const ethnicity = req.body.ethnicity || '汉族'
    const marital_status = req.body.maritalStatus || req.body.marital_status || ''
    const political_status = req.body.politicalStatus || req.body.political_status || '群众'
    const military_service = req.body.militaryService || req.body.military_service || '未服兵役'
    const education_level = req.body.educationLevel || req.body.education_level || ''
    const registered_date =
      req.body.registeredDate || req.body.registered_date || new Date().toISOString().split('T')[0]
    const equity_shares = req.body.equityShares || req.body.equity_shares || 0

    // 新增字段：职业和健康状况
    const occupation = req.body.occupation || null
    const health_status = req.body.healthStatus || req.body.health_status || null

    console.log('解析后的数据:', {
      household_id,
      name,
      idCard,
      gender,
      dateOfBirth,
      relationship_to_head,
      occupation,
      health_status
    })

    const sql = `INSERT INTO residents 
                 (household_id, name, gender, date_of_birth, id_card, relationship_to_head, ethnicity, 
                  marital_status, political_status, military_service, bank_card, bank_name, village_group, 
                  education_level, phone_number, registered_date, status, household_head_id, Home_address, equity_shares,
                  occupation, health_status) 
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`

    const params = [
      household_id,
      name,
      gender,
      dateOfBirth,
      idCard,
      relationship_to_head,
      ethnicity,
      marital_status,
      political_status,
      military_service,
      bankCard,
      bankName,
      villageGroup,
      education_level,
      phoneNumber,
      registered_date,
      status,
      household_head_id,
      homeAddress,
      equity_shares,
      occupation,
      health_status
    ]

    console.log('执行SQL:', sql)
    console.log('SQL参数:', params)

    const [result] = await db.pool.execute(sql, params)
    console.log('插入成功, insertId:', result.insertId)

    res.json({ code: 20000, message: '新增居民成功', data: { id: result.insertId } })
  } catch (err) {
    console.error('========== 新增居民失败 ==========')
    console.error('错误信息:', err.message)
    console.error('错误代码:', err.code)
    console.error('错误详情:', err.sqlMessage || err.message)
    console.error('完整错误:', err)

    if (err.message.includes('Duplicate entry') && err.message.includes('id_card')) {
      return res.status(400).json({ code: 400, message: '身份证号已存在，无法重复添加' })
    }
    return res
      .status(500)
      .json({ code: 500, message: '新增居民失败: ' + (err.sqlMessage || err.message) })
  }
})

// 搜索建议API - 返回居民姓名和户主姓名的搜索建议
router.get('/search-suggestions', checkPermission('resident:view'), (req, res) => {
  const { keyword, type } = req.query
  console.log('收到/search-suggestions请求，关键字:', keyword, '类型:', type)

  if (!keyword) {
    res.json({ code: 20000, residentNames: [], householdHeadNames: [] })
    return
  }

  // 构建查询参数
  const searchKeyword = `%${keyword}%`
  const results = {
    residentNames: [],
    householdHeadNames: []
  }

  // 查询居民姓名建议
  if (!type || type === 'residentNames') {
    const residentSql = `SELECT DISTINCT name FROM residents WHERE name LIKE ? AND status = 'active' LIMIT 10`
    db.all(residentSql, [searchKeyword], (residentErr, residentRows) => {
      if (residentErr) {
        console.error('查询居民姓名建议失败:', residentErr.message)
      } else {
        results.residentNames = residentRows.map((row) => ({
          value: row.name,
          label: row.name
        }))
      }

      // 如果只需要居民姓名建议，直接返回结果
      if (type === 'residentNames') {
        res.json({ code: 20000, ...results })
      }
    })
  }

  // 查询户主姓名建议
  if (!type || type === 'householdHeadNames') {
    const householdSql = `SELECT 
                            h.household_number,
                            h.household_head_name,
                            h.address,
                            h.village_group,
                            h.id as householdHeadId,
                            h.household_type,
                            h.housing_type,
                            h.gender,
                            h.household_head_id_card as householdHeadIdCard,
                            h.phone_number as phoneNumber,
                            h.ethnicity
                          FROM households h
                          WHERE h.household_head_name LIKE ? AND h.status = 'active' 
                          LIMIT 10`
    db.all(householdSql, [searchKeyword], (householdErr, householdRows) => {
      if (householdErr) {
        console.error('查询户主姓名建议失败:', householdErr.message)
      } else {
        results.householdHeadNames = householdRows.map((row) => ({
          householdNumber: row.household_number,
          householdHeadName: row.household_head_name,
          address: row.address,
          villageGroup: row.village_group,
          householdHeadId: row.householdHeadId,
          householdType: row.household_type,
          housingType: row.housing_type,
          gender: row.gender,
          householdHeadIdCard: row.householdHeadIdCard,
          phoneNumber: row.phoneNumber,
          ethnicity: row.ethnicity,
          value: row.household_head_name
        }))
      }

      // 如果只需要户主姓名建议，或者需要所有建议，返回结果
      if (type === 'householdHeadNames' || !type) {
        res.json({ code: 20000, ...results })
      }
    })
  }
})

// 按姓名搜索居民并返回详细信息
router.get('/residents/search-by-name', checkPermission('resident:view'), (req, res) => {
  const { name } = req.query
  console.log('收到按姓名搜索居民请求，姓名:', name)

  if (!name) {
    res.json({ code: 20000, data: [] })
    return
  }

  // 构建查询参数
  const searchKeyword = `%${name}%`
  const sql = `SELECT 
                r.id, 
                r.name, 
                r.id_card AS idCard,
                r.gender,
                r.ethnicity,
                r.date_of_birth AS dateOfBirth,
                r.age,
                r.phone_number AS phoneNumber,
                r.homehold_id,
                r.Home_address AS homeAddress,
                r.occupation
              FROM residents r
              WHERE r.name LIKE ? AND r.status = 'active'
              LIMIT 10`

  db.all(sql, [searchKeyword], (err, rows) => {
    if (err) {
      console.error('按姓名搜索居民失败:', err.message)
      res.status(500).json({ code: 500, message: '搜索失败' })
      return
    }

    // 转换结果格式
    const result = rows.map((row) => ({
      id: row.id,
      name: row.name,
      idCard: row.idCard,
      gender: row.gender,
      ethnicity: row.ethnicity,
      dateOfBirth: row.dateOfBirth,
      age: row.age,
      phoneNumber: row.phoneNumber,
      householdId: row.household_id,
      homeAddress: row.homeAddress,
      occupation: row.occupation
    }))

    console.log('搜索到居民:', result.length, '条')
    res.json({ code: 20000, data: result })
  })
})

// 字典API - 返回字典表中的数据
router.get('/dictionaries', checkPermission('resident:view'), (req, res) => {
  const { category } = req.query

  console.log('收到字典API请求，category:', category)

  // 构建查询条件
  let sql = `SELECT id, category, value, display_order, status, created_at, updated_at 
             FROM dictionaries 
             WHERE status = 'active'`
  const params = []

  if (category) {
    sql += ` AND category = ?`
    params.push(category)
    console.log('添加category查询条件:', category)
  }

  // 添加排序
  sql += ` ORDER BY display_order ASC`

  console.log('执行SQL:', sql)
  console.log('SQL参数:', params)

  db.all(sql, params, (err, rows) => {
    if (err) {
      console.error('查询字典数据失败:', err.message)
      // 查询失败时返回空数组，而不是错误的模拟数据
      res.json({ code: 20000, data: [] })
      return
    }

    console.log('查询到字典数据:', rows.length, '条')
    rows.forEach((row) => {
      console.log('  ID:', row.id, 'Category:', row.category, 'Value:', row.value)
    })

    // 返回真实字典数据
    res.json({ code: 20000, data: rows })
  })
})

// 获取人口结构统计
router.get('/population-structure', checkPermission('resident:view'), async (req, res) => {
  console.log('获取人口结构统计...')

  try {
    // 按年龄段分组查询居民数据，需要从date_of_birth计算age
    const [rows] = await db.pool.execute(
      `SELECT
        CASE
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) < 7 THEN '0-6岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 7 AND 17 THEN '7-17岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 18 AND 59 THEN '18-59岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 60 AND 69 THEN '60-69岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 70 AND 79 THEN '70-79岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 80 AND 89 THEN '80-89岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 90 AND 99 THEN '90-99岁'
          ELSE '100岁以上'
        END as ageGroup,
        COUNT(*) as count
      FROM residents
      WHERE status = 'active'
      GROUP BY
        CASE
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) < 7 THEN '0-6岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 7 AND 17 THEN '7-17岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 18 AND 59 THEN '18-59岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 60 AND 69 THEN '60-69岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 70 AND 79 THEN '70-79岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 80 AND 89 THEN '80-89岁'
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 90 AND 99 THEN '90-99岁'
          ELSE '100岁以上'
        END
      ORDER BY
        CASE
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) < 7 THEN 0
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 7 AND 17 THEN 1
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 18 AND 59 THEN 2
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 60 AND 69 THEN 3
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 70 AND 79 THEN 4
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 80 AND 89 THEN 5
          WHEN (YEAR(CURDATE()) - YEAR(date_of_birth)) BETWEEN 90 AND 99 THEN 6
          ELSE 7
        END
    `
    )

    // 确保所有年龄段都存在，即使数量为0
    const allAgeGroups = [
      { ageGroup: '0-6岁', count: 0 },
      { ageGroup: '7-17岁', count: 0 },
      { ageGroup: '18-59岁', count: 0 },
      { ageGroup: '60-69岁', count: 0 },
      { ageGroup: '70-79岁', count: 0 },
      { ageGroup: '80-89岁', count: 0 },
      { ageGroup: '90-99岁', count: 0 },
      { ageGroup: '100岁以上', count: 0 }
    ]

    // 合并查询结果
    rows.forEach((row) => {
      const existingGroup = allAgeGroups.find((g) => g.ageGroup === row.ageGroup)
      if (existingGroup) {
        existingGroup.count = row.count
      }
    })

    res.json({
      code: 20000,
      success: true,
      message: '获取人口结构统计成功',
      data: allAgeGroups
    })
  } catch (err) {
    console.error('查询人口结构统计失败:', err.message)
    res.status(500).json({ code: 500, message: '查询人口结构统计失败: ' + err.message })
  }
})

// 获取居民的户籍变动记录 - 必须放在 /residents/:id 之前
router.get('/residents/:id/change-logs', checkPermission('resident:view'), (req, res) => {
  const { id } = req.params

  const sql = `SELECT * FROM household_change_log WHERE resident_id = ? ORDER BY change_date DESC`

  db.all(sql, [id], (err, rows) => {
    if (err) {
      console.error('获取户籍变动记录失败:', err.message)
      return res.status(500).json({ code: 500, message: '获取户籍变动记录失败' })
    }

    res.json({ code: 20000, data: rows })
  })
})

module.exports = router
