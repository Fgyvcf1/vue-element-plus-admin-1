# 职务字段设计方案

## 背景分析

### 问题
- 班子成员表单需要填写"职务"字段
- 居民信息表 `residents` 中没有职务字段
- 需要确定职务字段应该放在哪个表

### 分析
1. **居民表不加职务字段** - 正确决策
   - 一个居民在不同时期可能担任不同职务
   - 职务是特定于某个机构和任期的业务属性
   - 居民表是基础信息表,应保持纯净

2. **系统已有字典表 `dictionaries`** - 可复用
   - 表结构: `id, category, value, display_order, status, created_at, updated_at`
   - 已用于: 村组、政治面貌、婚姻状况、兵役情况、教育程度、与户主关系等
   - 完全可以扩展用于职务管理

## 设计方案

### 1. 数据库设计

#### committee_members 表结构
```sql
CREATE TABLE committee_members (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  resident_id INTEGER NOT NULL,           -- 关联居民ID
  organization_type TEXT NOT NULL,           -- 机构类型
  position TEXT NOT NULL,                  -- 职务(从字典表选择)
  status TEXT NOT NULL DEFAULT 'current',   -- 现任/历届
  term_start_date TEXT NOT NULL,           -- 任期开始
  term_end_date TEXT,                     -- 任期结束(历届必填)
  remarks TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (resident_id) REFERENCES residents(id)
)
```

**关键点:**
- `position` 字段存储职务名称(如: 书记、主任等)
- 不存储职务ID,直接存储值,简化查询和显示
- 通过前端筛选,根据机构类型加载对应职务

### 2. 字典表数据设计

#### 职务字典分类

| category (分类) | 说明 | value (值)示例 | display_order |
|----------------|------|----------------|---------------|
| 职务_支部委员会 | 支部委员会职务 | 书记、副书记、委员 | 1,2,3 |
| 职务_村民委员会 | 村民委员会职务 | 主任、副主任、委员 | 1,2,3 |
| 职务_集体经济组织理事会 | 集体经济组织理事会职务 | 理事长、副理事长、理事 | 1,2,3 |
| 职务_集体经济组织监事会 | 集体经济组织监事会职务 | 主席、监事 | 1,2 |
| 职务_村务监督委员会 | 村务监督委员会职务 | 主任、副主任、委员 | 1,2,3 |
| 职务_村民小组长 | 村民小组长职务 | 组长 | 1 |
| 职务_村民代表 | 村民代表职务 | 代表 | 1 |
| 职务_青年团妇组织 | 青年团妇组织职务 | 团支部书记、妇联主任、其他 | 1,2,3 |

#### 完整字典数据

```sql
-- 支部委员会
INSERT INTO dictionaries (category, value, display_order, status)
VALUES
  ('职务_支部委员会', '书记', 1, 'active'),
  ('职务_支部委员会', '副书记', 2, 'active'),
  ('职务_支部委员会', '委员', 3, 'active');

-- 村民委员会
INSERT INTO dictionaries (category, value, display_order, status)
VALUES
  ('职务_村民委员会', '主任', 1, 'active'),
  ('职务_村民委员会', '副主任', 2, 'active'),
  ('职务_村民委员会', '委员', 3, 'active');

-- 集体经济组织理事会
INSERT INTO dictionaries (category, value, display_order, status)
VALUES
  ('职务_集体经济组织理事会', '理事长', 1, 'active'),
  ('职务_集体经济组织理事会', '副理事长', 2, 'active'),
  ('职务_集体经济组织理事会', '理事', 3, 'active');

-- 集体经济组织监事会
INSERT INTO dictionaries (category, value, display_order, status)
VALUES
  ('职务_集体经济组织监事会', '主席', 1, 'active'),
  ('职务_集体经济组织监事会', '监事', 2, 'active');

-- 村务监督委员会
INSERT INTO dictionaries (category, value, display_order, status)
VALUES
  ('职务_村务监督委员会', '主任', 1, 'active'),
  ('职务_村务监督委员会', '副主任', 2, 'active'),
  ('职务_村务监督委员会', '委员', 3, 'active');

-- 村民小组长
INSERT INTO dictionaries (category, value, display_order, status)
VALUES
  ('职务_村民小组长', '组长', 1, 'active');

-- 村民代表
INSERT INTO dictionaries (category, value, display_order, status)
VALUES
  ('职务_村民代表', '代表', 1, 'active');

-- 青年团妇组织
INSERT INTO dictionaries (category, value, display_order, status)
VALUES
  ('职务_青年团妇组织', '团支部书记', 1, 'active'),
  ('职务_青年团妇组织', '妇联主任', 2, 'active'),
  ('职务_青年团妇组织', '其他', 3, 'active');
```

## 前端实现方案

### 1. 职务下拉框联动逻辑

```vue
<template>
  <el-form-item label="职务" prop="position">
    <el-select
      v-model="form.position"
      placeholder="请选择职务"
      :loading="positionLoading"
      :disabled="!form.organizationType"
    >
      <el-option
        v-for="item in positionOptions"
        :key="item.id"
        :label="item.value"
        :value="item.value"
      />
    </el-select>
  </el-form-item>
</template>

<script>
export default {
  data() {
    return {
      positionOptions: [], // 职务选项列表
      positionLoading: false
    }
  },
  watch: {
    // 监听机构类型变化,加载对应职务
    'form.organizationType'(newVal) {
      if (newVal) {
        this.loadPositionOptions(newVal);
      }
    }
  },
  methods: {
    // 加载职务选项
    async loadPositionOptions(orgType) {
      const categoryMap = {
        'branch_committee': '职务_支部委员会',
        'village_committee': '职务_村民委员会',
        'economic_council': '职务_集体经济组织理事会',
        'economic_supervisor': '职务_集体经济组织监事会',
        'supervisory_committee': '职务_村务监督委员会',
        'group_leader': '职务_村民小组长',
        'village_representative': '职务_村民代表',
        'youth_women_org': '职务_青年团妇组织'
      };

      const category = categoryMap[orgType];
      if (!category) return;

      this.positionLoading = true;
      try {
        const { data } = await getDictionaryByCategory(category);
        this.positionOptions = data;
      } catch (error) {
        this.$message.error('加载职务选项失败');
      } finally {
        this.positionLoading = false;
      }
    }
  }
}
</script>
```

### 2. 居民选择自动填充逻辑

```vue
<template>
  <el-form-item label="居民姓名" prop="residentId">
    <el-select
      v-model="form.residentId"
      placeholder="请选择居民"
      filterable
      remote
      :remote-method="searchResidents"
      :loading="residentLoading"
      @change="handleResidentChange"
    >
      <el-option
        v-for="item in residentOptions"
        :key="item.id"
        :label="item.name"
        :value="item.id"
      >
        <span>{{ item.name }}</span>
        <span style="color: #8492a6; font-size: 13px; margin-left: 10px;">
          {{ item.idCard }}
        </span>
      </el-option>
    </el-select>
  </el-form-item>
</template>

<script>
export default {
  methods: {
    // 居民选择变化时,自动填充
    async handleResidentChange(residentId) {
      if (!residentId) {
        // 清空表单
        this.form.phone = '';
        this.form.gender = '';
        this.form.birthDate = '';
        return;
      }

      try {
        const { data } = await getResident(residentId);
        // 自动填充已有字段
        this.form.name = data.name;
        this.form.gender = data.gender;
        this.form.phone = data.phone_number;
        this.form.birthDate = data.date_of_birth;
        this.form.idCard = data.id_card;
        this.form.villageGroup = data.village_group;
      } catch (error) {
        this.$message.error('获取居民信息失败');
      }
    }
  }
}
</script>
```

## 后端API实现

### 职务字典查询API

```javascript
// 已存在于 routes.js
router.get('/dictionaries', (req, res) => {
  const { category } = req.query;

  let sql = `SELECT id, category, value, display_order, status
             FROM dictionaries
             WHERE status = 'active'`;
  const params = [];

  if (category) {
    sql += ` AND category = ?`;
    params.push(category);
  }

  sql += ` ORDER BY display_order ASC`;

  db.all(sql, params, (err, rows) => {
    if (err) {
      console.error('查询字典数据失败:', err.message);
      res.json({ code: 500, message: '查询失败', data: [] });
      return;
    }

    res.json({ code: 20000, data: rows });
  });
});
```

## 使用步骤

### 1. 初始化数据库

```bash
cd backend

# 创建班子成员表
node create-committee-tables.js

# 插入职务字典数据
node insert-position-dictionary.js

# 验证字典数据
node check-dictionaries-db.js
```

### 2. 前端使用

1. 导入字典API
```javascript
import { getDictionaryByCategory } from '@/api/dictionary';
```

2. 根据机构类型加载对应职务
```javascript
const categoryMap = {
  'branch_committee': '职务_支部委员会',
  'village_committee': '职务_村民委员会',
  // ... 其他映射
};

const { data } = await getDictionaryByCategory(categoryMap[orgType]);
```

## 优势

### 1. 数据一致性
- 职务统一管理,避免手动输入错误
- 新增职务类型只需在字典表添加数据

### 2. 可维护性
- 字典数据集中管理
- 支持排序(display_order)
- 支持启用/禁用(status)

### 3. 可扩展性
- 未来新增机构类型,只需添加对应的职务分类
- 支持同一机构下多层级职务(书记、副书记、委员)

### 4. 查询性能
- 职务从字典表查询,已有索引优化
- 不需要额外的JOIN操作

## 注意事项

1. **机构类型先选**: 职务下拉框必须先选择机构类型才能加载
2. **字典缓存**: 可以在前端缓存职务数据,避免重复请求
3. **默认选择**: 可以设置第一个职务为默认值,提升用户体验
4. **空值处理**: 如果机构没有配置职务,显示友好提示
