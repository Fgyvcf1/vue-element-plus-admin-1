# 数据库索引优化说明

## 概述

为提升系统整体查询性能,特别是表单下拉查询和关联查询的效率,已创建全局索引优化脚本。

## 索引分类

### 1. 居民表 (residents) - 核心索引

| 索引名称                    | 字段          | 用途                       | 影响范围 |
| --------------------------- | ------------- | -------------------------- | -------- |
| idx_residents_name          | name          | 所有表单的居民姓名下拉查询 | 全局     |
| idx_residents_id_card       | id_card       | 快速查找居民、关联查询     | 全局     |
| idx_residents_village_group | village_group | 按村组筛选                 | 居民管理 |
| idx_residents_status        | status        | 筛选正常/迁出/死亡         | 居民管理 |
| idx_residents_household_id  | household_id  | 查询户成员                 | 居民管理 |

### 2. 调解相关表索引

| 表 | 索引名称 | 字段 | 用途 |
| --- | --- | --- | --- |
| mediators | idx_mediators_resident_id | resident_id | 关联居民信息 |
| mediators | idx_mediators_status | status | 筛选状态 |
| mediation_records | idx_mediation_records_applicant_id | applicant_id | 查询申请人记录 |
| mediation_records | idx_mediation_records_respondent_id | respondent_id | 查询被申请人记录 |
| mediation_records | idx_mediation_records_mediator_id | mediator_id | 查询调解员记录 |
| mediation_records | idx_mediation_records_date | mediation_date | 按日期查询统计 |
| mediation_record_images | idx_mediation_images_record_id | record_id | 查询记录图片 |
| mediation_record_mediators | idx_mediators_rel_record_id | record_id | 查询记录的调解员 |
| mediation_record_mediators | idx_mediators_rel_mediator_id | mediator_id | 查询调解员的记录 |

### 3. 通知相关表索引

| 表             | 索引名称                     | 字段       | 用途            |
| -------------- | ---------------------------- | ---------- | --------------- |
| notifications  | idx_notifications_type       | type       | 按类型筛选      |
| notifications  | idx_notifications_status     | status     | 筛选草稿/已发送 |
| notifications  | idx_notifications_created_at | created_at | 按时间排序      |
| reminder_rules | idx_reminder_rules_rule_type | rule_type  | 按类型筛选      |
| reminder_rules | idx_reminder_rules_status    | status     | 筛选启用/禁用   |

### 4. 特殊人群表索引

| 表                 | 索引名称                   | 字段        | 用途     |
| ------------------ | -------------------------- | ----------- | -------- |
| low_income_persons | idx_low_income_resident_id | resident_id | 关联居民 |
| low_income_persons | idx_low_income_status      | status      | 筛选状态 |
| disabled_persons   | idx_disabled_resident_id   | resident_id | 关联居民 |

### 5. 班子成员表 (committee_members) - 新模块索引

| 索引名称                          | 字段              | 用途                   |
| --------------------------------- | ----------------- | ---------------------- |
| idx_committee_members_resident_id | resident_id       | **核心: 居民下拉查询** |
| idx_committee_members_org_type    | organization_type | Tab切换机构            |
| idx_committee_members_status      | status            | 筛选现任/历届          |
| idx_committee_members_term_start  | term_start_date   | 按任期排序             |

## 使用方法

### 创建全局索引

```bash
cd backend
node create-global-indexes.js
```

### 创建班子成员表和索引

```bash
cd backend
node create-committee-tables.js
```

## 性能提升预期

### 场景1: 居民下拉查询 (最常用)

- **优化前**: 全表扫描,假设10000条记录,约10-50ms
- **优化后**: 使用 `idx_residents_name` 索引,约0.1-1ms
- **提升**: 10-100倍

### 场景2: 班子成员Tab切换

- **优化前**: 查询时过滤 `organization_type`,约5-20ms
- **优化后**: 使用 `idx_committee_members_org_type` 索引,约0.1-0.5ms
- **提升**: 10-40倍

### 场景3: 筛选现任/历届

- **优化前**: 全表扫描,约5-10ms
- **优化后**: 使用 `idx_committee_members_status` 索引,约0.1-0.3ms
- **提升**: 15-100倍

### 场景4: 关联查询 (居民信息自动填充)

- **优化前**: 多表JOIN无索引,约20-50ms
- **优化后**: 使用 `resident_id` 索引加速JOIN,约1-5ms
- **提升**: 5-20倍

## 索引设计原则

1. **高频查询字段优先**: `name`, `id_card`, `organization_type`, `status` 等频繁查询字段
2. **外键字段必索引**: 所有 `resident_id` 等外键字段都建立索引
3. **组合查询支持**: 复合查询场景(如机构+状态)可以建立复合索引
4. **按时间排序**: `created_at`, `term_start_date` 等时间字段建立索引

## 注意事项

1. **索引空间占用**: 索引会增加数据库文件大小,约10-20%
2. **写入性能**: 插入/更新/删除操作会稍慢(但查询大幅提升)
3. **定期维护**: SQLite会自动维护索引,但大量删除后建议执行 VACUUM
4. **查询分析**: 可使用 `EXPLAIN QUERY PLAN` 分析查询是否使用索引

## 验证索引是否生效

```sql
-- 查看表的索引
PRAGMA index_list(table_name);

-- 查看索引详情
PRAGMA index_info(index_name);

-- 分析查询计划
EXPLAIN QUERY PLAN SELECT * FROM committee_members WHERE organization_type = 'branch_committee';
```

## 后续优化建议

1. **复合索引**: 对于经常一起查询的字段,可以建立复合索引

   ```sql
   CREATE INDEX idx_committee_org_status ON committee_members(organization_type, status);
   ```

2. **部分索引**: 对于大数据表,可以只对活跃数据建索引

   ```sql
   CREATE INDEX idx_active_residents ON residents(name) WHERE status = 'active';
   ```

3. **覆盖索引**: 包含查询所需所有字段,避免回表查询

4. **定期重建索引**: 大量数据变动后,重建索引以优化性能
